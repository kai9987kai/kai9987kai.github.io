<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Creative Canvas</title>
    <style>
        /* Reset and Global Styles */
        :root {
            --primary-bg-729: #121212;
            --secondary-bg-836: #1e1e1e;
            --accent-color-254: #4a4a4a;
            --text-color-901: #e0e0e0;
            --highlight-color-634: #6200ee;
            --transition-speed-123: 0.3s;
            --sparkle-color-123: rgba(255, 215, 0, 1);
            --sparkle-size-456: 3px;
            --sparkle-speed-789: 0.02;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: all var(--transition-speed-123) ease;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', 'Helvetica Neue', sans-serif;
            background-color: var(--primary-bg-729);
            color: var(--text-color-901);
            line-height: 1.6;
        }

         /* App Container */
        .app-container-123 {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* Innovative Sidebar */
        .sidebar-321 {
            width: 300px;
            background-color: var(--secondary-bg-836);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 2px solid var(--accent-color-254);
            overflow-y: auto;
        }

        .tool-section-456 {
            margin-bottom: 20px;
            background-color: var(--accent-color-254);
            border-radius: 8px;
            padding: 15px;
        }

        .tool-section-456 h3 {
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .tool-btn-654 {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background-color: var(--highlight-color-634);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            transition: transform 0.2s, background-color 0.2s;
        }

        .tool-btn-654:hover {
            transform: scale(1.05);
            background-color: #7c3aff;
        }

        .color-picker-123, .emoji-picker-container-456, .label-tools-456 {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-container-789 {
             position: relative;
            width: 100%;
            margin-bottom: 15px;
        }

         .input-container-789 canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .input-container-789 input, .input-container-789 label {
            position: relative;
            z-index: 1;
        }

        .color-picker-123 label, .stroke-width-container-789 label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .color-picker-123 input, .stroke-width-container-789 input {
            width: 100%;
            height: 40px;
            border: 2px solid var(--accent-color-254);
            background-color: var(--primary-bg-729);
            color: var(--text-color-901);
            cursor: pointer;
            border-radius: 5px;
        }

        .stroke-width-container-789 {
            display: flex;
            flex-direction: column;
        }

        .stroke-width-container-789 input[type="range"] {
            width: 100%;
            cursor: pointer;
        }

        /* Emoji Picker */
         .emoji-picker-456 {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .emoji-btn-321 {
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            border: none;
            background: none;
            transition: transform 0.2s;
        }

        .emoji-btn-321:hover {
            transform: scale(1.3);
        }

          /* Label Tools */
        .label-input-567 {
             width: 100%;
            padding: 8px;
            border: 1px solid var(--accent-color-254);
            border-radius: 5px;
            margin-bottom: 10px;
            background-color: var(--primary-bg-729);
            color: var(--text-color-901);
        }
        .label-tools-456 {
            display: flex;
            flex-direction: column;
             margin-bottom: 15px;
        }

        /* Canvas Area */
        .canvas-container-999 {
            flex-grow: 1;
            position: relative;
            background: linear-gradient(45deg, #1a1a2e, #16213e);
            overflow: hidden;
        }

         #mainCanvas-999 {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            background: rgba(255,255,255,0.05);
        }
    /* Layer Management */
        .layer-panel-101 {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(30, 30, 30, 0.9);
            border-radius: 10px;
            padding: 15px;
            max-height: 400px;
            width: 250px;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .layer-panel-101 h3 {
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .layer-item-202 {
             display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--accent-color-254);
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            font-size: 0.9em;
        }

         .layer-controls-303 {
            display: flex;
            gap: 5px;
        }

        .layer-controls-303 button {
           background: none;
            border: none;
            color: var(--text-color-901);
            cursor: pointer;
            font-size: 1em;
        }

        /* Resize Handles Styles */
        .resize-handle-123 {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--highlight-color-634);
            border: 1px solid #fff;
            cursor: nwse-resize;
            z-index: 1000;
        }

         .top-left-123 { top: -4px; left: -4px; cursor: nwse-resize; }
        .top-right-123 { top: -4px; right: -4px; cursor: nesw-resize; }
        .bottom-left-123 { bottom: -4px; left: -4px; cursor: nesw-resize; }
        .bottom-right-123 { bottom: -4px; right: -4px; cursor: nwse-resize; }
          .top-mid-123 { top: -4px; left: 50%; transform: translateX(-50%); cursor: ns-resize; width: 10px; }
        .bottom-mid-123 { bottom: -4px; left: 50%; transform: translateX(-50%); cursor: ns-resize; width: 10px; }
        .mid-left-123 { top: 50%; left: -4px; transform: translateY(-50%); cursor: ew-resize; height: 10px; }
        .mid-right-123 { top: 50%; right: -4px; transform: translateY(-50%); cursor: ew-resize; height: 10px; }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar-321 {
                width: 250px;
            }
            .layer-panel-101{
                width: 200px;
            }
        }

         @media (max-width: 768px) {
            .app-container-123 {
                flex-direction: column;
            }
            .sidebar-321 {
                width: 100%;
                height: auto;
            }
            .layer-panel-101 {
                position: static;
                width: 100%;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container-123">
        <!-- Innovative Sidebar -->
        <div class="sidebar-321">
            <div class="tool-section-456">
                <h3>Drawing Tools</h3>
                <button class="tool-btn-654" id="freeDrawBtn">Free Draw</button>
                <button class="tool-btn-654" id="rectangleBtn">Rectangle</button>
                <button class="tool-btn-654" id="circleBtn">Circle</button>
                <button class="tool-btn-654" id="lineBtn">Line</button>
                <button class="tool-btn-654" id="contourBtn">Contour Maker</button>
            </div>
            <div class="tool-section-456">
            <h3>Label Tools</h3>
                <div class="label-tools-456">
                  <input type="text" class="label-input-567" id="labelInput" placeholder="Enter Label Text">
                   <button class="tool-btn-654" id="addLabelBtn">Add Label</button>
                   <input type="color" id="labelColorPicker" value="#FFFFFF">
                </div>
           </div>

            <div class="tool-section-456">
                <h3>Color & Style</h3>
                <div class="color-picker-123">
                    <div class="input-container-789">
                         <canvas></canvas>
                         <label for="strokeColorPicker">Stroke Color</label>
                        <input type="color" id="strokeColorPicker" value="#4a4a4a">
                    </div>
                     <div class="input-container-789">
                         <canvas></canvas>
                         <label for="fillColorPicker">Fill Color</label>
                        <input type="color" id="fillColorPicker" value="#6200ee">
                    </div>
                </div>
                <div class="stroke-width-container-789">
                    <label for="strokeWidth">Stroke Width</label>
                    <div class="input-container-789">
                        <canvas></canvas>
                        <input type="range" id="strokeWidth" min="1" max="20" value="3">
                    </div>
                </div>
            </div>

            <div class="tool-section-456">
                <h3>Emojis</h3>
                <div class="emoji-picker-456">
                    <!-- Existing Emojis -->
                    <button class="emoji-btn-321" data-emoji="üöó">üöó</button>
                    <button class="emoji-btn-321" data-emoji="üÖøÔ∏è">üÖøÔ∏è</button>
                    <button class="emoji-btn-321" data-emoji="üõ£Ô∏è">üõ£Ô∏è</button>
                    <button class="emoji-btn-321" data-emoji="üöß">üöß</button>
                    <button class="emoji-btn-321" data-emoji="üèûÔ∏è">üèûÔ∏è</button>
                    <button class="emoji-btn-321" data-emoji="üö¶">üö¶</button>
                    <!-- New Road-Related Emojis -->
                    <button class="emoji-btn-321" data-emoji="üõ§Ô∏è">üõ§Ô∏è</button> <!-- Railway Track -->
                    <button class="emoji-btn-321" data-emoji="üõ£Ô∏è">üõ£Ô∏è</button> <!-- Motorway -->
                    <button class="emoji-btn-321" data-emoji="üöè">üöè</button> <!-- Bus Stop -->
                    <button class="emoji-btn-321" data-emoji="üö≤">üö≤</button> <!-- Bicycle -->
                    <button class="emoji-btn-321" data-emoji="üèéÔ∏è">üèéÔ∏è</button> <!-- Racing Car -->
                    <button class="emoji-btn-321" data-emoji="üöç">üöç</button> <!-- Bus -->
                    <button class="emoji-btn-321" data-emoji="üöô">üöô</button> <!-- Recreational Vehicle -->
                    <button class="emoji-btn-321" data-emoji="üõµ">üõµ</button> <!-- Motor Scooter -->
                    <button class="emoji-btn-321" data-emoji="üöõ">üöõ</button> <!-- Articulated Lorry -->
                    <button class="emoji-btn-321" data-emoji="üöì">üöì</button> <!-- Police Car -->
                    <button class="emoji-btn-321" data-emoji="üöë">üöë</button> <!-- Ambulance -->
                    <button class="emoji-btn-321" data-emoji="üöö">üöö</button> <!-- Delivery Truck -->
                     <button class="emoji-btn-321" data-emoji="üõ∫">üõ∫</button> <!-- Auto Rickshaw -->
                    <!-- Add more road-related emojis as needed -->
                </div>
            </div>

            <div class="tool-section-456">
                <h3>Actions</h3>
                <button class="tool-btn-654" id="undoBtn">Undo</button>
                <button class="tool-btn-654" id="redoBtn">Redo</button>
                <button class="tool-btn-654" id="clearBtn">Clear</button>
                <button class="tool-btn-654" id="exportBtn">Export</button>
            </div>
        </div>

        <!-- Canvas Container -->
        <div class="canvas-container-999">
            <!-- Embedded DALL¬∑E sample image (1√ó1 pixel in base64) -->
            <img
                src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGMAAQAADQABX2lGZQAAAABJRU5ErkJggg=="
                alt="DALL¬∑E sample"
                style="position: absolute; top: 10px; left: 10px; width: 1px; height: 1px;"
            />

            <canvas id="mainCanvas-999"></canvas>
            
            <!-- Layer Management Panel -->
             <div class="layer-panel-101">
                <h3>Layers</h3>
                <div id="layerList">
                    <!-- Layers will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>

   <script>
    const SparkleEffect_414 = (() => {
        const canvas_911 = document.createElement('canvas');
        const ctx_912 = canvas_911.getContext('2d');
        canvas_911.classList.add('sparkle-canvas-123');
        document.body.appendChild(canvas_911);

        function resizeCanvas_913() {
            canvas_911.width = window.innerWidth;
            canvas_911.height = window.innerHeight;
        }
         resizeCanvas_913();
        window.addEventListener('resize', resizeCanvas_913);

        class Particle_914 {
           constructor(x_915, y_916) {
               this.x_915 = x_915;
               this.y_916 = y_916;
                this.size_917 = Math.random() * 3 + 1;
                this.speedX_918 = Math.random() * 3 - 1.5;
                this.speedY_919 = Math.random() * -3 - 1;
               this.opacity_920 = 1;
           }
           update_921() {
               this.x_915 += this.speedX_918;
               this.y_916 += this.speedY_919;
               this.opacity_920 -= 0.02;
           }
          draw_922() {
               ctx_912.fillStyle = 'rgba(255, 215, 0, ' + this.opacity_920 + ')';
               ctx_912.beginPath();
              ctx_912.arc(this.x_915, this.y_916, this.size_917, 0, Math.PI * 2);
              ctx_912.fill();
            }
        }

        const particles_923 = [];
        function createParticles_924(x_925, y_926) {
            for (let i_927 = 0; i_927 < 5; i_927++) {
              particles_923.push(new Particle_914(x_925, y_926));
           }
       }

        function animate_928() {
            ctx_912.clearRect(0, 0, canvas_911.width, canvas_911.height);
            for (let i_929 = particles_923.length - 1; i_929 >= 0; i_929--) {
               particles_923[i_929].update_921();
               particles_923[i_929].draw_922();
              if (particles_923[i_929].opacity_920 <= 0) {
                   particles_923.splice(i_929, 1);
                }
            }
          requestAnimationFrame(animate_928);
        }
       animate_928();

       return {
            createParticles: createParticles_924,
        };
     })();

        class AdvancedDrawingTool_457 {
            constructor(canvasId_458) {
                this.canvas_459 = document.getElementById(canvasId_458);
                this.ctx_460 = this.canvas_459.getContext('2d');
                this.setupCanvas_461();
                 this.history_462 = [];
                this.historyIndex_463 = -1;

                this.currentTool_464 = 'freeDraw'; // default tool
                this.isDrawing_465 = false;
                 this.isDraggingEmoji_466 = false;
                 this.isResizing_467 = false;
                 this.selectedResizeHandle_468 = null;
                 this.resizeStartX_469 = 0;
                 this.resizeStartY_470 = 0;

                this.lastX_471 = 0;
                this.lastY_472 = 0;
                this.startX_473 = 0;
                 this.startY_474 = 0;

               this.emojis_475 = [];
                 this.selectedEmoji_476 = null;
                this.dragOffsetX_477 = 0;
                 this.dragOffsetY_478 = 0;
                this.labels_479 = [];
                this.selectedLabel_480 = null;
                this.isDraggingLabel_481 = false;
                this.labelDragOffsetX_482 = 0;
                this.labelDragOffsetY_483 = 0;

                this.initializeListeners_484();
                 this.saveState_485();
                this.selectedShape_486 = null;
                this.resizeBox_487 = null;
            }

            setupCanvas_461() {
                 this.resizeCanvas_488();
                this.ctx_460.lineCap = 'round';
                this.ctx_460.strokeStyle = document.getElementById('strokeColorPicker').value;
                this.ctx_460.fillStyle = document.getElementById('fillColorPicker').value;
                 this.ctx_460.lineWidth = document.getElementById('strokeWidth').value;
            }

            initializeListeners_484() {
                document.getElementById('freeDrawBtn').addEventListener('click', () => this.setTool_489('freeDraw'));
                document.getElementById('rectangleBtn').addEventListener('click', () => this.setTool_489('rectangle'));
                document.getElementById('circleBtn').addEventListener('click', () => this.setTool_489('circle'));
                document.getElementById('lineBtn').addEventListener('click', () => this.setTool_489('line'));
                 document.getElementById('contourBtn').addEventListener('click', () => this.setTool_489('contour'));

                document.getElementById('strokeColorPicker').addEventListener('change', (e) => {
                    this.ctx_460.strokeStyle = e.target.value;
               });
               document.getElementById('fillColorPicker').addEventListener('change', (e) => {
                    this.ctx_460.fillStyle = e.target.value;
               });
                document.getElementById('strokeWidth').addEventListener('input', (e) => {
                     this.ctx_460.lineWidth = e.target.value;
               });

              const emojiPicker_490 = document.querySelector('.emoji-picker-456');
              emojiPicker_490.addEventListener('click', (e) => {
                   if (e.target.classList.contains('emoji-btn-321')) {
                      const emoji_491 = e.target.getAttribute('data-emoji');
                       this.selectEmoji_492(emoji_491);
                    }
              });
               document.getElementById('addLabelBtn').addEventListener('click', () => this.addLabel_493());

                document.getElementById('labelColorPicker').addEventListener('change', (e) => {
                    this.labelColor = e.target.value;
               });


                this.canvas_459.addEventListener('mousedown', (e) => this.onMouseDown_494(e));
               this.canvas_459.addEventListener('mousemove', (e) => this.onMouseMove_495(e));
                 this.canvas_459.addEventListener('mouseup', (e) => this.onMouseUp_496(e));
                 this.canvas_459.addEventListener('mouseout', (e) => this.onMouseUp_496(e));

                document.getElementById('undoBtn').addEventListener('click', () => this.undo_497());
                document.getElementById('redoBtn').addEventListener('click', () => this.redo_498());
               document.getElementById('clearBtn').addEventListener('click', () => this.clearCanvas_499());
                 document.getElementById('exportBtn').addEventListener('click', () => this.exportCanvas_500());

                   this.initializeParticleEffects_501();
                window.addEventListener('resize', () => this.resizeCanvas_488());
            }

            resizeCanvas_488() {
                const tempCanvas_502 = document.createElement('canvas');
                const tempCtx_503 = tempCanvas_502.getContext('2d');
                tempCanvas_502.width = this.canvas_459.width;
                tempCanvas_502.height = this.canvas_459.height;
               tempCtx_503.drawImage(this.canvas_459, 0, 0);

                this.canvas_459.width = this.canvas_459.parentElement.clientWidth;
                this.canvas_459.height = this.canvas_459.parentElement.clientHeight;
                 this.ctx_460.drawImage(tempCanvas_502, 0, 0);
                 this.render_504();
             }

            setTool_489(tool_505) {
                this.currentTool_464 = tool_505;
                 this.canvas_459.style.cursor = (tool_505 === 'freeDraw' || tool_505 === 'contour') ? 'crosshair' : 'default';
            }

            selectEmoji_492(emoji_506) {
                this.currentTool_464 = 'emoji';
                this.selectedEmoji_476 = emoji_506;
                this.canvas_459.style.cursor = 'pointer';
            }
             addLabel_493() {
                const labelText_507 = document.getElementById('labelInput').value;
                if(labelText_507) {
                   this.currentTool_464 = 'label';
                }

             }


           onMouseDown_494(e_508) {
                const { offsetX: offsetX_509, offsetY: offsetY_510 } = e_508;

                 if (this.currentTool_464 === 'label' && document.getElementById('labelInput').value) {
                     this.labels_479.push({
                        text: document.getElementById('labelInput').value,
                       x: offsetX_509,
                       y: offsetY_510,
                        color: document.getElementById('labelColorPicker').value,
                    });
                  this.saveState_485();
                 this.render_504();
                   document.getElementById('labelInput').value = '';
                   this.currentTool_464 = 'freeDraw';
                    return;
                  }
                if (this.currentTool_464 === 'emoji' && this.selectedEmoji_476) {
                     this.emojis_475.push({
                        emoji: this.selectedEmoji_476,
                       x: offsetX_509,
                      y: offsetY_510,
                         size: 24
                   });
                     this.saveState_485();
                     this.render_504();
                    return;
                }
              const clickedEmoji_511 = this.getEmojiAtPosition_512(offsetX_509, offsetY_510);
              if (clickedEmoji_511) {
                   this.isDraggingEmoji_466 = true;
                   this.selectedEmoji_476 = clickedEmoji_511;
                     this.dragOffsetX_477 = offsetX_509 - clickedEmoji_511.x;
                    this.dragOffsetY_478 = offsetY_510 - clickedEmoji_511.y;
                 return;
                }
                 const clickedLabel_513 = this.getLabelAtPosition_514(offsetX_509, offsetY_510);
                if (clickedLabel_513) {
                    this.isDraggingLabel_481 = true;
                    this.selectedLabel_480 = clickedLabel_513;
                    this.labelDragOffsetX_482 = offsetX_509 - clickedLabel_513.x;
                   this.labelDragOffsetY_483 = offsetY_510 - clickedLabel_513.y;
                   return;
                 }

                  const shapeClicked = this.getShapeAtPosition_515(offsetX_509, offsetY_510);
               if (shapeClicked) {
                   this.selectedShape_486 = shapeClicked;
                    this.renderResizeBox_516(this.selectedShape_486);
                   return;
              }

            if(this.resizeBox_487) {
                 const handleClicked = this.getResizeHandleAtPosition_517(offsetX_509, offsetY_510);
                 if(handleClicked) {
                    this.selectedResizeHandle_468 = handleClicked;
                     this.isResizing_467 = true;
                      this.resizeStartX_469 = offsetX_509;
                    this.resizeStartY_470 = offsetY_510;
                      return;
                 }
              }


                this.isDrawing_465 = true;
                 [this.lastX_471, this.lastY_472] = [offsetX_509, offsetY_510];
                this.startX_473 = offsetX_509;
               this.startY_474 = offsetY_510;

                 if (this.currentTool_464 === 'contour') {
                    // Custom behavior can be added here
                }
           }

          onMouseMove_495(e_518) {
                const { offsetX: offsetX_519, offsetY: offsetY_520 } = e_518;

                  if (this.isDraggingEmoji_466 && this.selectedEmoji_476) {
                     this.selectedEmoji_476.x = offsetX_519 - this.dragOffsetX_477;
                    this.selectedEmoji_476.y = offsetY_520 - this.dragOffsetY_478;
                     this.render_504();
                     return;
                }
                 if (this.isDraggingLabel_481 && this.selectedLabel_480) {
                     this.selectedLabel_480.x = offsetX_519 - this.labelDragOffsetX_482;
                   this.selectedLabel_480.y = offsetY_520 - this.labelDragOffsetY_483;
                    this.render_504();
                    return;
               }


                  if(this.isResizing_467 && this.selectedShape_486){
                       this.resizeShape_521(offsetX_519, offsetY_520);
                       this.renderResizeBox_516(this.selectedShape_486);
                      return;
                }
                 if (!this.isDrawing_465) return;
                  this.ctx_460.beginPath();
                switch(this.currentTool_464) {
                   case 'freeDraw':
                        this.ctx_460.moveTo(this.lastX_471, this.lastY_472);
                       this.ctx_460.lineTo(offsetX_519, offsetY_520);
                        this.ctx_460.stroke();
                        [this.lastX_471, this.lastY_472] = [offsetX_519, offsetY_520];
                       break;
                     case 'line':
                         this.restoreLastState_522();
                        this.ctx_460.moveTo(this.startX_473, this.startY_474);
                         this.ctx_460.lineTo(offsetX_519, offsetY_520);
                        this.ctx_460.stroke();
                        break;
                    case 'rectangle':
                        this.restoreLastState_522();
                        const width_523 = offsetX_519 - this.startX_473;
                        const height_524 = offsetY_520 - this.startY_474;
                       this.ctx_460.strokeRect(this.startX_473, this.startY_474, width_523, height_524);
                       break;
                   case 'circle':
                        this.restoreLastState_522();
                       const radius_525 = Math.sqrt(
                            Math.pow(offsetX_519 - this.startX_473, 2) +
                            Math.pow(offsetY_520 - this.startY_474, 2)
                        );
                        this.                        ctx_460.beginPath();
                        this.ctx_460.arc(this.startX_473, this.startY_474, radius_525, 0, Math.PI * 2);
                        this.ctx_460.stroke();
                       break;
                   case 'contour':
                        this.ctx_460.strokeStyle = '#FF8C00';
                        this.ctx_460.moveTo(this.lastX_471, this.lastY_472);
                         this.ctx_460.lineTo(offsetX_519, offsetY_520);
                       this.ctx_460.stroke();
                        [this.lastX_471, this.lastY_472] = [offsetX_519, offsetY_520];
                       break;
                }
           }

          onMouseUp_496(e_526) {
               if (this.isDraggingEmoji_466) {
                    this.isDraggingEmoji_466 = false;
                    this.saveState_485();
                   return;
                }

                  if (this.isDraggingLabel_481) {
                      this.isDraggingLabel_481 = false;
                     this.saveState_485();
                   return;
                }
               if (this.isResizing_467) {
                     this.isResizing_467 = false;
                     this.selectedResizeHandle_468 = null;
                      this.saveState_485();
                    return;
                }
              if (!this.isDrawing_465) return;
              this.isDrawing_465 = false;
                this.saveState_485();
            }


           getEmojiAtPosition_512(x_527, y_528) {
                 for (let i_529 = this.emojis_475.length - 1; i_529 >= 0; i_529--) {
                    const emoji_530 = this.emojis_475[i_529];
                    const size_531 = emoji_530.size;
                     if (x_527 >= emoji_530.x - size_531 && x_527 <= emoji_530.x + size_531 &&
                        y_528 >= emoji_530.y - size_531 && y_528 <= emoji_530.y + size_531) {
                         return emoji_530;
                    }
                 }
                 return null;
            }
            getLabelAtPosition_514(x_532, y_533) {
                for (let i_534 = this.labels_479.length - 1; i_534 >= 0; i_534--) {
                  const label_535 = this.labels_479[i_534];
                    this.ctx_460.font = "16px Arial";
                    const textWidth_536 = this.ctx_460.measureText(label_535.text).width;
                     const textHeight_537 = 16;
                  if (x_532 >= label_535.x && x_532 <= label_535.x + textWidth_536 &&
                      y_533 >= label_535.y - textHeight_537 && y_533 <= label_535.y) {
                      return label_535;
                   }
               }
                return null;
           }
            getShapeAtPosition_515(x_538, y_539) {
               if(this.history_462.length === 0) return null;
                 const currentState_540 = this.history_462[this.historyIndex_463];
              let shape = null;
                const tempCanvas_541 = document.createElement('canvas');
                const tempCtx_542 = tempCanvas_541.getContext('2d');
                 tempCanvas_541.width = this.canvas_459.width;
                tempCanvas_541.height = this.canvas_459.height;
                 tempCtx_542.putImageData(currentState_540, 0, 0);

                const pixelData_543 = tempCtx_542.getImageData(x_538, y_539, 1, 1).data;
                if(pixelData_543[3] !== 0){
                      shape = {
                        x:x_538,
                        y:y_539,
                     }
                 }
                return shape;
           }

            renderEmojis_544() {
              if (Array.isArray(this.emojis_475)) {
                    this.emojis_475.forEach(emojiObj_545 => {
                        this.ctx_460.font = `${emojiObj_545.size}px Arial`;
                         this.ctx_460.fillText(emojiObj_545.emoji, emojiObj_545.x, emojiObj_545.y);
                    });
               } else {
                  console.warn('Emojis data is not an array:', this.emojis_475);
                }
             }

              renderLabels_546() {
               if(Array.isArray(this.labels_479)){
                  this.labels_479.forEach(labelObj_547 => {
                       this.ctx_460.font = "16px Arial";
                       this.ctx_460.fillStyle = labelObj_547.color || '#000';
                      this.ctx_460.fillText(labelObj_547.text, labelObj_547.x, labelObj_547.y);
                  })
               } else {
                  console.warn('Labels data is not an array:', this.labels_479);
               }

             }

            restoreLastState_522() {
                if (this.historyIndex_463 >= 0) {
                    const lastState_548 = this.history_462[this.historyIndex_463];
                   this.ctx_460.putImageData(lastState_548, 0, 0);
                 }
            }


            saveState_485() {
                if (this.historyIndex_463 < this.history_462.length - 1) {
                  this.history_462 = this.history_462.slice(0, this.historyIndex_463 + 1);
                }
               const imageData_549 = this.ctx_460.getImageData(0, 0, this.canvas_459.width, this.canvas_459.height);
                this.history_462.push(imageData_549);
                 this.historyIndex_463++;
                this.updateLayerList_550();
            }

            undo_497() {
              if (this.historyIndex_463 > 0) {
                  this.historyIndex_463--;
                    const previousState_551 = this.history_462[this.historyIndex_463];
                    this.ctx_460.putImageData(previousState_551, 0, 0);
                     this.renderEmojis_544();
                     this.renderLabels_546();
                 }
            }

           redo_498() {
                 if (this.historyIndex_463 < this.history_462.length - 1) {
                      this.historyIndex_463++;
                      const nextState_552 = this.history_462[this.historyIndex_463];
                      this.ctx_460.putImageData(nextState_552, 0, 0);
                      this.renderEmojis_544();
                      this.renderLabels_546();
                  }
           }

            clearCanvas_499() {
                 this.ctx_460.clearRect(0, 0, this.canvas_459.width, this.canvas_459.height);
                 this.emojis_475 = [];
                this.labels_479 = [];
                  this.saveState_485();
                 this.render_504();
           }

            exportCanvas_500() {
                 const dataURL_553 = this.canvas_459.toDataURL('image/png');
                 const link_554 = document.createElement('a');
                 link_554.download = 'creative-canvas.png';
                link_554.href = dataURL_553;
                 link_554.click();
             }


          render_504() {
                  this.ctx_460.clearRect(0, 0, this.canvas_459.width, this.canvas_459.height);
                 if (this.historyIndex_463 >= 0) {
                   const currentState_555 = this.history_462[this.historyIndex_463];
                    this.ctx_460.putImageData(currentState_555, 0, 0);
                }
              this.renderEmojis_544();
               this.renderLabels_546();
               if (this.selectedShape_486) {
                    this.renderResizeBox_516(this.selectedShape_486)
               }
          }

            updateLayerList_550() {
                  const layerList_556 = document.getElementById('layerList');
                layerList_556.innerHTML = '';

                this.history_462.forEach((state_557, index_558) => {
                    const layerItem_559 = document.createElement('div');
                    layerItem_559.classList.add('layer-item-202');
                  layerItem_559.textContent = `Layer ${index_558 + 1}`;

                     const controls_560 = document.createElement('div');
                     controls_560.classList.add('layer-controls-303');

                     const viewBtn_561 = document.createElement('button');
                    viewBtn_561.innerHTML = 'üëÅÔ∏è';
                   viewBtn_561.title = 'View Layer';
                   viewBtn_561.addEventListener('click', () => {
                        this.historyIndex_463 = index_558;
                        this.render_504();
                   });

                  const deleteBtn_562 = document.createElement('button');
                   deleteBtn_562.innerHTML = '‚ùå';
                    deleteBtn_562.title = 'Delete Layer';
                   deleteBtn_562.addEventListener('click', () => {
                      this.history_462.splice(index_558, 1);
                        if (this.historyIndex_463 >= this.history_462.length) {
                           this.historyIndex_463 = this.history_462.length - 1;
                        }
                      this.render_504();
                       this.updateLayerList_550();
                    });

                     controls_560.appendChild(viewBtn_561);
                   controls_560.appendChild(deleteBtn_562);
                    layerItem_559.appendChild(controls_560);
                   layerList_556.appendChild(layerItem_559);
               });
            }

           initializeParticleEffects_501() {
              const inputContainers_563 = document.querySelectorAll('.input-container-789');
              inputContainers_563.forEach(container_564 => {
                 const canvas_565 = container_564.querySelector('canvas');
                    const input_566 = container_564.querySelector('input');
                    if (canvas_565 && input_566) {
                       const ctx_567 = canvas_565.getContext('2d');
                        canvas_565.width = container_564.clientWidth;
                      canvas_565.height = container_564.clientHeight;
                       const particles_568 = [];
                          class Particle_569 {
                            constructor(x_570, y_571) {
                                this.x_570 = x_570;
                                 this.y_571 = y_571;
                                this.radius = Math.random() * 2 + 1;
                                   this.color = 'rgba(255, 140, 0, 0.8)';
                                  this.speedX = (Math.random() - 0.5) * 2;
                                this.speedY = (Math.random() - 0.5) * 2;
                                  this.opacity = 1;
                             }

                             update_572() {
                                   this.x_570 += this.speedX;
                                  this.y_571 += this.speedY;
                                this.opacity -= 0.02;
                            }

                              draw_573(ctx_574) {
                                  ctx_574.beginPath();
                                   ctx_574.arc(this.x_570, this.y_571, this.radius, 0, Math.PI * 2);
                                  ctx_574.fillStyle = this.color.replace('0.8', this.opacity.toFixed(2));
                                   ctx_574.fill();
                            }
                         }

                           input_566.addEventListener('input', (e_575) => {
                                const rect_576 = input_566.getBoundingClientRect();
                                const x_577 = Math.random() * canvas_565.width;
                              const y_578 = Math.random() * canvas_565.height;
                              particles_568.push(new Particle_569(x_577, y_578));
                           });
                         function animate_579() {
                                ctx_567.clearRect(0, 0, canvas_565.width, canvas_565.height);
                                particles_568.forEach((particle_580, index_581) => {
                                      particle_580.update_572();
                                     if (particle_580.opacity <= 0) {
                                          particles_568.splice(index_581, 1);
                                   } else {
                                          particle_580.draw_573(ctx_567);
                                      }
                                 });
                              requestAnimationFrame(animate_579);
                            }
                          animate_579();

                           window.addEventListener('resize', () => {
                              canvas_565.width = container_564.clientWidth;
                               canvas_565.height = container_564.clientHeight;
                           });
                      }
                 });
            }
              renderResizeBox_516(shape_582){
                if (!shape_582) return;

                const tempCanvas_583 = document.createElement('canvas');
                const tempCtx_584 = tempCanvas_583.getContext('2d');
                tempCanvas_583.width = this.canvas_459.width;
                tempCanvas_583.height = this.canvas_459.height;
                tempCtx_584.drawImage(this.canvas_459,0,0);


                const pixelData_585 = tempCtx_584.getImageData(0,0, this.canvas_459.width, this.canvas_459.height);
                 const points_586 = []
                  for(let y = 0; y < this.canvas_459.height; y++) {
                     for(let x = 0; x < this.canvas_459.width; x++) {
                        const index = (y * this.canvas_459.width + x) * 4;
                       if (pixelData_585.data[index+3] !== 0) {
                            points_586.push({x, y});
                       }
                     }
                 }

               if(points_586.length === 0) return;
                   let minX = points_586[0].x;
                    let minY = points_586[0].y;
                   let maxX = points_586[0].x;
                   let maxY = points_586[0].y;

                 for(const point_587 of points_586) {
                    minX = Math.min(minX, point_587.x);
                   minY = Math.min(minY, point_587.y);
                    maxX = Math.max(maxX, point_587.x);
                     maxY = Math.max(maxY, point_587.y);
                  }

               const boxWidth_588 = maxX - minX;
               const boxHeight_589 = maxY - minY;
                this.resizeBox_487 = {x: minX, y: minY, width: boxWidth_588, height: boxHeight_589}

                 this.ctx_460.strokeStyle = '#fff';
                this.ctx_460.strokeRect(minX, minY, boxWidth_588, boxHeight_589);
                   const handleSize_590 = 8;

                 this.renderResizeHandle_591(minX - handleSize_590 / 2 , minY - handleSize_590/ 2, 'top-left-123');
                  this.renderResizeHandle_591(maxX - handleSize_590 / 2, minY - handleSize_590/ 2, 'top-right-123');
                   this.renderResizeHandle_591(minX - handleSize_590 / 2, maxY - handleSize_590 / 2, 'bottom-left-123');
                  this.renderResizeHandle_591(maxX - handleSize_590 / 2, maxY - handleSize_590/ 2, 'bottom-right-123');

                this.renderResizeHandle_591(minX + boxWidth_588 /2 - handleSize_590 /2, minY - handleSize_590 / 2, 'top-mid-123');
                this.renderResizeHandle_591(minX + boxWidth_588 /2 - handleSize_590/ 2, maxY - handleSize_590 / 2, 'bottom-mid-123');

                this.renderResizeHandle_591(minX - handleSize_590/2 , minY + boxHeight_589 /2 - handleSize_590 /2 , 'mid-left-123');
               this.renderResizeHandle_591(maxX - handleSize_590 /2, minY + boxHeight_589 /2 - handleSize_590/ 2, 'mid-right-123');

            }

             renderResizeHandle_591(x_592, y_593, className_594) {
                   const handle_595 = document.createElement('div');
                handle_595.classList.add('resize-handle-123', className_594);
                   handle_595.style.left = x_592 + 'px';
                   handle_595.style.top = y_593 + 'px';
                 this.canvas_459.parentNode.appendChild(handle_595)

           }
             getResizeHandleAtPosition_517(x_596, y_597){
                if(!this.resizeBox_487) return null;
                   const handleSize_598 = 8;
                  const {x: boxX_599, y: boxY_600, width: boxWidth_601, height: boxHeight_602} = this.resizeBox_487;
                   const handles = [
                    {x: boxX_599 - handleSize_598 / 2 , y: boxY_600 - handleSize_598/ 2 , class:'top-left-123' },
                      {x: boxX_599 + boxWidth_601 - handleSize_598 / 2, y: boxY_600 - handleSize_598/ 2 , class:'top-right-123' },
                      {x: boxX_599- handleSize_598 / 2, y: boxY_600 + boxHeight_602- handleSize_598/ 2 , class:'bottom-left-123'},
                     {x: boxX_599 + boxWidth_601 - handleSize_598 / 2, y: boxY_600+ boxHeight_602 - handleSize_598/ 2, class:'bottom-right-123'},

                   {x: boxX_599+ boxWidth_601/2 - handleSize_598 /2, y: boxY_600 - handleSize_598 / 2 ,class:'top-mid-123'},
                  {x: boxX_599 + boxWidth_601/2 - handleSize_598/ 2, y: boxY_600 + boxHeight_602 - handleSize_598/ 2, class:'bottom-mid-123'},

                    {x: boxX_599 - handleSize_598/2, y: boxY_600+ boxHeight_602 /2 - handleSize_598/2, class:'mid-left-123'},
                   {x: boxX_599 + boxWidth_601 - handleSize_598/2, y: boxY_600 + boxHeight_602/2 - handleSize_598/2 , class:'mid-right-123'}
                 ]

                  for(const handle_603 of handles){
                      if (x_596 >= handle_603.x && x_596 <= handle_603.x + handleSize_598 &&
                        y_597 >= handle_603.y && y_597 <= handle_603.y + handleSize_598) {
                       return handle_603.class
                    }
                }
                return null;
             }

             resizeShape_521(mouseX_604, mouseY_605){
                if(!this.selectedShape_486 || !this.resizeBox_487 || !this.selectedResizeHandle_468) return;
                 const { x: boxX_606, y: boxY_607, width: boxWidth_608, height: boxHeight_609 } = this.resizeBox_487;
                   const deltaX_610 = mouseX_604 - this.resizeStartX_469;
                  const deltaY_611 = mouseY_605 - this.resizeStartY_470;
                   this.resizeStartX_469 = mouseX_604;
                    this.resizeStartY_470 = mouseY_605;

                let newBox_612 = {...this.resizeBox_487}

                  switch(this.selectedResizeHandle_468){
                     case 'top-left-123':
                           newBox_612.x = boxX_606 + deltaX_610;
                        newBox_612.y = boxY_607 + deltaY_611;
                        newBox_612.width = boxWidth_608 - deltaX_610;
                        newBox_612.height = boxHeight_609 - deltaY_611;
                       break;
                     case 'top-right-123':
                        newBox_612.y = boxY_607 + deltaY_611;
                       newBox_612.width = boxWidth_608 + deltaX_610;
                       newBox_612.height = boxHeight_609 - deltaY_611;
                         break;
                     case 'bottom-left-123':
                       newBox_612.x = boxX_606 + deltaX_610;
                       newBox_612.width = boxWidth_608 - deltaX_610;
                     newBox_612.height = boxHeight_609 + deltaY_611;
                         break;
                  case 'bottom-right-123':
                    newBox_612.width = boxWidth_608 + deltaX_610;
                    newBox_612.height = boxHeight_609 + deltaY_611;
                        break;
                 case 'top-mid-123':
                  newBox_612.y = boxY_607 + deltaY_611;
                     newBox_612.height = boxHeight_609 - deltaY_611;
                        break;
                     case 'bottom-mid-123':
                         newBox_612.height = boxHeight_609 + deltaY_611;
                        break;
                      case 'mid-left-123':
                        newBox_612.x = boxX_606 + deltaX_610;
                        newBox_612.width = boxWidth_608 - deltaX_610;
                        break;
                    case 'mid-right-123':
                     newBox_612.width = boxWidth_608 + deltaX_610;
                       break;
                 }

                  this.resizeBox_487 = newBox_612;
                   this.ctx_460.clearRect(0, 0, this.canvas_459.width, this.canvas_459.height);
                 this.restoreLastState_522()
                  this.renderEmojis_544();
                   this.renderLabels_546();

                  this.ctx_460.drawImage(this.canvas_459, 0, 0);

              }

        }

        window.addEventListener('load', () => {
            const drawingTool_613 = new AdvancedDrawingTool_457('mainCanvas-999');
           document.querySelectorAll('input[type="text"], textarea').forEach((element_614) => {
               element_614.addEventListener('input', (event_615) => {
                    const rect_616 = event_615.target.getBoundingClientRect();
                    const cursorPosition_617 = event_615.target.selectionStart;
                    const textBeforeCursor_618 = event_615.target.value.substring(0, cursorPosition_617);
                     const tempSpan_619 = document.createElement('span');
                    tempSpan_619.style.position = 'absolute';
                    tempSpan_619.style.visibility = 'hidden';
                  tempSpan_619.style.whiteSpace = 'pre';
                   tempSpan_619.style.font = window.getComputedStyle(event_615.target).font;
                    tempSpan_619.textContent = textBeforeCursor_618;
                     document.body.appendChild(tempSpan_619);
                    const cursorX_620 = rect_616.left + tempSpan_619.offsetWidth;
                    const cursorY_621 = rect_616.top + rect_616.height / 2;
                   document.body.removeChild(tempSpan_619);
                  SparkleEffect_414.createParticles(cursorX_620, cursorY_621);
                });
           });
        });
    </script>
</body>
</html>
