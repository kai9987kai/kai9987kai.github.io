<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Alcohol Unit Tracker ‚Äî Advanced</title>
<meta name="description" content="Track alcohol units with accurate UK calculations, rolling 7-day insights, calories/cost estimates, notifications, and export/import.">
<style>
  :root{
    --bg:#f0f0f0;--fg:#222;--card:#fff;--muted:#666;
    --primary:#0d6efd;--primary-hover:#0b5ed7;
    --warn:#dc3545;--ok:#2ba84a;--amber:#ff9800;
    --border:#ddd;--soft:#fafafa;--accent:#7b1fa2
  }
  [data-theme="dark"]{
    --bg:#1b1c1f;--fg:#eee;--card:#26282c;--muted:#aaa;
    --primary:#17a2b8;--primary-hover:#117a8b;
    --border:#3a3d42;--soft:#1f2124;--accent:#b388ff
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:var(--bg);color:var(--fg);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial
  }
  .container{
    max-width:1000px;margin:24px auto;padding:20px;
    background:var(--card);border-radius:12px;
    box-shadow:0 6px 24px rgba(0,0,0,.08);
    border:1px solid var(--border)
  }
  h1{margin:0 0 6px;text-align:center;font-weight:800;letter-spacing:.2px}
  .sub{margin:0 0 18px;text-align:center;color:var(--muted)}
  .grid{
    display:grid;gap:12px;margin:8px 0 18px;
    grid-template-columns:repeat(12,1fr)
  }
  .card{
    background:var(--soft);border:1px solid var(--border);border-radius:12px;padding:14px
  }
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="number"],input[type="text"],select{
    width:100%;padding:10px 12px;border:1px solid var(--border);
    border-radius:10px;background:var(--card);color:var(--fg)
  }
  button{
    cursor:pointer;border:0;border-radius:10px;padding:10px 14px;
    background:var(--primary);color:#fff;font-weight:700
  }
  button:hover{background:var(--primary-hover)}
  .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--fg)}
  .btn-warn{background:var(--warn)}
  .btn-amber{background:var(--amber);color:#111}
  .btn-ok{background:var(--ok)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 10px;border-radius:999px;border:1px solid var(--border);
    background:var(--card);cursor:pointer;font-size:14px
  }
  .pill strong{font-variant-numeric:tabular-nums}
  .flex{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .right{margin-left:auto}
  .muted{color:var(--muted)}
  .kpi{
    display:grid;grid-template-columns:repeat(4,1fr);gap:10px
  }
  .kpi .item{
    background:var(--soft);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center
  }
  .kpi .item .big{font-size:28px;font-weight:900;letter-spacing:.3px}
  .note{font-size:13px;color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--border);padding:8px;text-align:center}
  th{background:var(--soft)}
  canvas{width:100%!important;max-height:320px}
  .theme-toggle{
    position:fixed;top:10px;right:10px;z-index:9
  }
  .badge{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:var(--card)}
  .danger{color:#fff;background:var(--warn);border-color:transparent}
  .warn{background:var(--amber);color:#111;border-color:transparent}
  .ok{background:var(--ok);color:#fff;border-color:transparent}
  .accent{background:var(--accent);color:#fff;border-color:transparent}
  details{border:1px solid var(--border);border-radius:12px;padding:10px;background:var(--soft)}
  details summary{cursor:pointer;font-weight:700}
  .sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0;padding:0;margin:-1px}
</style>
</head>
<body data-theme="light">
  <button id="toggleTheme" class="theme-toggle pill" aria-live="polite" title="Toggle dark/light">
    <span>üåì</span><span id="themeLabel">Dark</span>
  </button>
  <div class="container" role="application" aria-label="Alcohol Unit Tracker">
    <h1>Alcohol Unit Tracker</h1>
    <p class="sub">
      UK guideline: <strong>‚â§14 units per week</strong>, spread over <strong>3+ days</strong>, with several drink-free days. There‚Äôs no ‚Äúsafe‚Äù level.<br>
      <span class="note">Formula: units = ABV% √ó volume(ml) √∑ 1000 ‚Ä¢ 1 unit = 10 ml (~8 g) ethanol ‚Ä¢ ~56 kcal per unit (alcohol only).</span>
    </p>

    <!-- Settings / status -->
    <div class="grid">
      <div class="card" style="grid-column: span 12;">
        <div class="row">
          <div class="pill"><span>Weekly limit</span>
            <input id="weeklyLimit" type="number" min="0" step="1" style="width:90px" aria-label="Weekly unit limit">
            <span class="muted">units</span>
          </div>
          <div class="pill"><span>Mode</span>
            <select id="weekMode" aria-label="Week mode">
              <option value="rolling">Rolling 7-day</option>
              <option value="calendar">Calendar week (Mon‚ÄìSun)</option>
            </select>
          </div>
          <div class="pill"><span>¬£/unit</span>
            <input id="pricePerUnit" type="number" min="0" step="0.01" style="width:90px" aria-label="Price per unit">
          </div>
          <div class="pill"><span>kcal/unit</span>
            <input id="kcalPerUnit" type="number" min="0" step="1" style="width:90px" aria-label="Calories per unit">
          </div>
          <button id="notifyBtn" class="btn-amber">Enable Notifications</button>
          <span id="migrationBadge" class="badge accent" style="display:none">Migrated v1 ‚ûú v2</span>
          <span class="right badge">Local-only ‚Ä¢ Offline ready</span>
        </div>
      </div>
    </div>

    <!-- Quick presets + calculator -->
    <div class="grid">
      <div class="card" style="grid-column: span 12;">
        <div class="row" aria-label="Quick presets">
          <button class="pill" data-preset="beer_pint_4">üç∫ Pint Lager 4% (568 ml) <strong data-units>‚Ä¶u</strong></button>
          <button class="pill" data-preset="wine_175_12">üç∑ Wine 175 ml 12% <strong data-units>‚Ä¶u</strong></button>
          <button class="pill" data-preset="wine_250_13">üç∑ Wine 250 ml 13% <strong data-units>‚Ä¶u</strong></button>
          <button class="pill" data-preset="spirit_double_40">ü•É Spirit Double 40% (50 ml) <strong data-units>‚Ä¶u</strong></button>
          <button class="pill" data-preset="cider_pint_4_5">üçé Cider Pint 4.5% <strong data-units>‚Ä¶u</strong></button>
          <button class="pill" data-preset="alcopop_330_4">ü•§ Alcopop 330 ml 4% <strong data-units>‚Ä¶u</strong></button>
          <button class="pill" data-preset="cocktail_est_2">üçπ Cocktail (est.) 2u <strong data-units>2.0u</strong></button>
        </div>
        <div class="grid" role="group" aria-label="Custom drink calculator">
          <div class="card" style="grid-column: span 12;">
            <div class="row">
              <div>
                <label for="drinkLabel">Label</label>
                <input id="drinkLabel" type="text" placeholder="e.g., IPA, Merlot, Gin & Tonic" />
              </div>
              <div>
                <label for="drinkMl">Volume (ml)</label>
                <input id="drinkMl" type="number" min="0" step="1" value="568"/>
              </div>
              <div>
                <label for="drinkAbv">ABV (%)</label>
                <input id="drinkAbv" type="number" min="0" step="0.1" value="4.0"/>
              </div>
              <div>
                <label>Units (calc)</label>
                <div class="pill"><strong id="calcUnits">2.27</strong> u</div>
              </div>
              <div class="right flex">
                <button id="addDrink" class="btn-ok">Add Drink</button>
                <button id="undoBtn" class="btn-ghost">Undo Last</button>
                <button id="removeUnitsBtn" class="btn-ghost">Remove Units</button>
                <input id="manualUnits" type="number" min="0" step="0.1" value="1.0" style="width:90px" aria-label="Manual units">
              </div>
            </div>
          </div>
        </div>
        <small class="note">Unit formula: units = ABV √ó ml √∑ 1000 (UK). Calories shown use your kcal/unit setting.</small>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpi" role="status" aria-live="polite">
      <div class="item">
        <div class="muted">Today</div>
        <div class="big" id="kpiTodayUnits">0.0u</div>
      </div>
      <div class="item">
        <div class="muted">This Week</div>
        <div class="big" id="kpiWeekUnits">0.0u</div>
      </div>
      <div class="item">
        <div class="muted">Calories (wk)</div>
        <div class="big" id="kpiWeekKcal">0</div>
      </div>
      <div class="item">
        <div class="muted">Cost (wk)</div>
        <div class="big" id="kpiWeekCost">¬£0.00</div>
      </div>
    </div>

    <!-- Status + Insights -->
    <div class="grid">
      <div class="card" style="grid-column: span 12;">
        <div id="status" style="font-size:18px;margin-bottom:6px"></div>
        <div id="insights" style="font-weight:700"></div>
        <div class="note" id="streakNote"></div>
      </div>
    </div>

    <!-- Charts -->
    <div class="grid">
      <div class="card" style="grid-column: span 6;">
        <h3 style="margin:0 0 8px">Today‚Äôs Consumption</h3>
        <canvas id="todayChart" aria-label="Today chart"></canvas>
      </div>
      <div class="card" style="grid-column: span 6;">
        <h3 style="margin:0 0 8px">7-Day History</h3>
        <canvas id="weeklyChart" aria-label="Weekly chart"></canvas>
      </div>
      <div class="card" style="grid-column: span 12;">
        <h3 style="margin:0 0 8px">Today by Drink Type</h3>
        <canvas id="todayPie" aria-label="Today breakdown chart"></canvas>
      </div>
    </div>

    <!-- Table + actions -->
    <div class="grid">
      <div class="card" style="grid-column: span 12;">
        <div class="row">
          <div class="flex">
            <button id="resetToday" class="btn-warn">Reset Today</button>
            <button id="resetWeek" class="btn-warn">Reset Week</button>
          </div>
          <div class="right flex">
            <button id="exportCSV" class="btn-ghost">Export CSV</button>
            <button id="exportJSON" class="btn-ghost">Export JSON</button>
            <input id="importJSON" type="file" accept=".json" style="display:none">
            <button id="importBtn" class="btn-ghost">Import JSON</button>
          </div>
        </div>
        <h3 style="margin:12px 0 6px">Weekly History Details</h3>
        <table aria-label="Weekly history">
          <thead><tr><th>Date</th><th>Units</th></tr></thead>
          <tbody id="historyTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Info -->
    <details>
      <summary>Info, health notes & sources</summary>
      <p class="note">
        UK guidance (NHS/CMOs): ‚â§14 units per week, spread over ‚â•3 days with drink-free days. 1 UK unit = 10 ml (‚âà8 g) ethanol. Calories from alcohol ‚âà7 kcal/g ‚âà56 kcal per unit (excludes mixers). This tool is informational and not medical advice. If you‚Äôre concerned about alcohol, see NHS resources or talk to a professional.
      </p>
    </details>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <script>
  (function(){
    "use strict";

    // ---------- Utilities ----------
    const $ = sel => document.querySelector(sel);
    const pad = n => String(n).padStart(2,'0');
    const today = () => new Date();
    const dateKey = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; // YYYY-MM-DD
    const isSameDay = (a,b) => dateKey(a) === dateKey(b);

    // ---------- Storage ----------
    const LS_KEY = "au_tracker_v2";
    const MIGRATED_KEY = "au_tracker_migrated_v1";

    const defaults = {
      settings: { weeklyLimit: 14, weekMode: "rolling", pricePerUnit: 0.0, kcalPerUnit: 56, theme: "light" },
      entries: [] // {ts,label,ml,abv,units,kcal,cost}
    };

    function loadState(){
      let state = JSON.parse(localStorage.getItem(LS_KEY) || "null") || structuredClone(defaults);
      // theme bootstrap
      document.body.setAttribute("data-theme", state.settings.theme || "light");
      $("#themeLabel").textContent = state.settings.theme === "dark" ? "Light" : "Dark";
      // one-time migrate v1
      if(!localStorage.getItem(MIGRATED_KEY)){
        const migrated = migrateV1(state);
        if(migrated){
          $("#migrationBadge").style.display = "inline-block";
          localStorage.setItem(MIGRATED_KEY,"1");
          saveState(state);
        }
      }
      return state;
    }
    function saveState(st){ localStorage.setItem(LS_KEY, JSON.stringify(st)); }

    function migrateV1(state){
      let changed = false;
      try{
        const v1today = JSON.parse(localStorage.getItem("trackerData")||"null");
        const v1week = JSON.parse(localStorage.getItem("weeklyData")||"[]");
        // weeklyData: [{date:"DD/MM/YYYY" or locale, units:n}]
        if(Array.isArray(v1week) && v1week.length){
          for(const e of v1week){
            const parsed = parseLooseDate(e.date);
            if(parsed && e.units>0){
              state.entries.push(makeEntry({
                ts: new Date(parsed.getFullYear(), parsed.getMonth(), parsed.getDate(), 12,0,0).toISOString(),
                label: "Legacy day total", ml: 0, abv: 0, units: Number(e.units)
              }));
              changed = true;
            }
          }
          localStorage.removeItem("weeklyData");
        }
        if(v1today && v1today.units>0 && v1today.date){
          const p = parseLooseDate(v1today.date) || new Date();
          state.entries.push(makeEntry({
            ts: new Date(p.getFullYear(), p.getMonth(), p.getDate(), 20,0,0).toISOString(),
            label: "Legacy today total", ml: 0, abv: 0, units: Number(v1today.units)
          }));
          localStorage.removeItem("trackerData");
          changed = true;
        }
      }catch(e){/* ignore */}
      return changed;
    }
    function parseLooseDate(s){
      if(!s) return null;
      // try ISO
      const iso = new Date(s); if(!isNaN(iso)) return iso;
      // try DD/MM/YYYY
      const m = String(s).match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if(m){ return new Date(Number(m[3]), Number(m[2])-1, Number(m[1])); }
      return null;
    }

    // ---------- Domain logic ----------
    function unitsFrom(abv, ml){ return (Number(abv)||0) * (Number(ml)||0) / 1000; }
    function kcalFrom(units, kcalPerUnit){ return (units * kcalPerUnit); }
    function costFrom(units, pricePerUnit){ return (units * pricePerUnit); }

    function makeEntry({ts,label,ml,abv,units}){
      const s = state.settings;
      const u = +Number(units || unitsFrom(abv, ml)).toFixed(2);
      return {
        ts: ts || new Date().toISOString(),
        label: (label||"Drink"),
        ml: Number(ml||0),
        abv: Number(abv||0),
        units: u,
        kcal: Math.round(kcalFrom(u, s.kcalPerUnit)),
        cost: Number(costFrom(u, s.pricePerUnit)).toFixed(2)
      };
    }

    function addEntry(entry){
      state.entries.push(entry);
      saveState(state);
      flashNotifyMilestones();
      renderAll();
    }
    function undoLast(){
      state.entries.pop();
      saveState(state);
      renderAll();
    }

    // Aggregations
    function entriesForDay(d){
      const key = dateKey(d);
      return state.entries.filter(e => dateKey(new Date(e.ts)) === key);
    }
    function sumUnits(list){ return Number(list.reduce((a,b)=>a + (Number(b.units)||0), 0).toFixed(2)); }
    function sumKcal(list){ return list.reduce((a,b)=>a + (Number(b.kcal)||0), 0); }
    function sumCost(list){ return list.reduce((a,b)=>a + (Number(b.cost)||0), 0); }

    function startOfWeek(d){ // Monday
      const c = new Date(d); const day = (c.getDay()+6)%7; c.setDate(c.getDate()-day); c.setHours(0,0,0,0); return c;
    }
    function rollingWindowDays(n){ const arr=[]; const t = today(); for(let i=n-1;i>=0;i--){ const d=new Date(t); d.setDate(t.getDate()-i); arr.push(d); } return arr; }

    function weeklyBuckets(mode){
      if(mode==="calendar"){
        const start = startOfWeek(today());
        const days = [...Array(7).keys()].map(i=>{const d=new Date(start); d.setDate(start.getDate()+i); return d;});
        return days.map(d => ({ date: dateKey(d), units: sumUnits(entriesForDay(d)) }));
      }else{
        return rollingWindowDays(7).map(d => ({ date: dateKey(d), units: sumUnits(entriesForDay(d)) }));
      }
    }

    function alcoholFreeStreak(){
      // count consecutive days ending yesterday with 0 units
      let streak = 0;
      for(let i=1;i<=365;i++){
        const d=new Date(); d.setDate(d.getDate()-i);
        const u = sumUnits(entriesForDay(d));
        if(u===0) streak++; else break;
      }
      return streak;
    }

    // ---------- Charts ----------
    let todayBar, weekLine, todayPie;
    function colorFor(p){ // 0..1 (green -> red)
      const red = Math.min(255, Math.floor(255*p));
      const green = Math.max(0, 255 - red);
      return `rgba(${red},${green},0,0.8)`;
    }

    function updateCharts(){
      const wk = weeklyBuckets(state.settings.weekMode);
      const todayUnits = sumUnits(entriesForDay(today()));
      const pct = Math.min(1.5, todayUnits/state.settings.weeklyLimit);
      const tcolor = colorFor(pct);

      // Today bar
      const ctx1 = $("#todayChart").getContext("2d");
      if(!todayBar){
        todayBar = new Chart(ctx1, {
          type: "bar",
          data: { labels:["Today"], datasets:[{ label:"Units", data:[todayUnits], backgroundColor:[tcolor], borderColor:[tcolor], borderWidth:1 }]},
          options: {
            responsive:true,
            scales:{ y:{ beginAtZero:true, suggestedMax: Math.max(10, state.settings.weeklyLimit/2)}},
            plugins:{ tooltip:{ callbacks:{ label:(c)=>`Units: ${c.parsed.y}` } } }
          }
        });
      }else{
        todayBar.data.datasets[0].data = [todayUnits];
        todayBar.data.datasets[0].backgroundColor = [tcolor];
        todayBar.data.datasets[0].borderColor = [tcolor];
        todayBar.update();
      }

      // Weekly line
      const ctx2 = $("#weeklyChart").getContext("2d");
      const labels = wk.map(x=>x.date);
      const vals = wk.map(x=>x.units);
      if(!weekLine){
        weekLine = new Chart(ctx2, {
          type:"line",
          data:{ labels, datasets:[{ label:"Daily Units", data:vals, borderWidth:2, tension:.2 }]},
          options:{ responsive:true, scales:{ y:{ beginAtZero:true, suggestedMax: Math.max(14, state.settings.weeklyLimit)} } }
        });
      }else{
        weekLine.data.labels = labels;
        weekLine.data.datasets[0].data = vals;
        weekLine.update();
      }

      // Today pie by labels
      const tEntries = entriesForDay(today());
      const byLabel = {};
      for(const e of tEntries){ byLabel[e.label] = (byLabel[e.label]||0) + e.units; }
      const pieLabels = Object.keys(byLabel);
      const pieVals = pieLabels.map(k=>+byLabel[k].toFixed(2));
      const ctx3 = $("#todayPie").getContext("2d");
      if(!todayPie){
        todayPie = new Chart(ctx3, {
          type:"doughnut",
          data:{ labels: pieLabels, datasets:[{ data: pieVals }] },
          options:{ responsive:true, plugins:{ legend:{ position:"bottom" } } }
        });
      }else{
        todayPie.data.labels = pieLabels;
        todayPie.data.datasets[0].data = pieVals;
        todayPie.update();
      }
    }

    // ---------- Rendering ----------
    function renderHistoryTable(){
      const tb = $("#historyTableBody");
      tb.innerHTML="";
      const wk = weeklyBuckets(state.settings.weekMode);
      for(const row of wk){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.date}</td><td>${row.units}</td>`;
        tb.appendChild(tr);
      }
    }

    function renderKPIs(){
      const tEntries = entriesForDay(today());
      const wk = weeklyBuckets(state.settings.weekMode);
      const todayU = sumUnits(tEntries);
      const weekU = wk.reduce((a,b)=>a+b.units,0);
      const wkCal = Math.round(kcalFrom(weekU, state.settings.kcalPerUnit));
      const wkCost = costFrom(weekU, state.settings.pricePerUnit);

      $("#kpiTodayUnits").textContent = `${todayU.toFixed(1)}u`;
      $("#kpiWeekUnits").textContent  = `${weekU.toFixed(1)}u`;
      $("#kpiWeekKcal").textContent   = `${wkCal}`;
      $("#kpiWeekCost").textContent   = `¬£${Number(wkCost).toFixed(2)}`;
    }

    function renderStatusAndInsights(){
      const wk = weeklyBuckets(state.settings.weekMode);
      const weekU = wk.reduce((a,b)=>a+b.units,0);
      const todayU = sumUnits(entriesForDay(today()));
      const limit = state.settings.weeklyLimit;
      const pct = (weekU/Math.max(1,limit))*100;

      let status = `Today: <strong>${todayU.toFixed(1)}u</strong> ‚Ä¢ This ${state.settings.weekMode==="rolling"?"7-day":"week"}: <strong>${weekU.toFixed(1)}u</strong> / ${limit}u`;
      let klass = "badge ok";
      if(weekU >= limit*1.5){ klass="badge danger"; }
      else if(weekU >= limit){ klass="badge warn"; }

      $("#status").innerHTML = `${status} <span class="${klass}" style="margin-left:8px">${pct.toFixed(0)}%</span>`;

      // Weekly average (last 7 including today)
      const avg = (wk.reduce((a,b)=>a+b.units,0)/wk.length)||0;
      const trend = (wk[6]?.units||0) - (wk[5]?.units||0);
      const trendText = trend>0 ? "‚Üë higher than yesterday" : trend<0 ? "‚Üì lower than yesterday" : "‚Üí same as yesterday";

      // Pace advice
      const dayIndex = state.settings.weekMode==="calendar"
        ? ((today().getDay()+6)%7)+1 // Mon=1..Sun=7
        : 7; // rolling window uses total 7 days; pace less meaningful, still hint using average
      const idealPace = state.settings.weekMode==="calendar"
        ? (limit/7)*dayIndex
        : (limit); // rolling compares to full limit
      const paceWarn = weekU > idealPace ? "You‚Äôre ahead of pace for the limit." : "You‚Äôre on or below pace.";

      $("#insights").innerHTML = `Weekly average: ${avg.toFixed(2)}u ‚Ä¢ ${trendText} ‚Ä¢ ${paceWarn}`;
      $("#streakNote").textContent = `Alcohol-free day streak: ${alcoholFreeStreak()} day(s).`;
    }

    function renderAll(){
      // controls
      $("#weeklyLimit").value   = state.settings.weeklyLimit;
      $("#weekMode").value      = state.settings.weekMode;
      $("#pricePerUnit").value  = state.settings.pricePerUnit;
      $("#kcalPerUnit").value   = state.settings.kcalPerUnit;
      // presets badges
      document.querySelectorAll("[data-preset]").forEach(btn=>{
        const u = presetUnits(btn.dataset.preset);
        const strong = btn.querySelector("[data-units]");
        if(strong) strong.textContent = `${u.toFixed(2)}u`;
      });

      // dependent UI
      renderKPIs();
      renderStatusAndInsights();
      renderHistoryTable();
      updateCharts();
      updateCalcUnits();
    }

    // ---------- Notifications ----------
    function requestNotify(){ Notification.requestPermission().then(()=>{}); }
    function flashNotifyMilestones(){
      if(!("Notification" in window) || Notification.permission!=="granted") return;
      const wk = weeklyBuckets(state.settings.weekMode);
      const weekU = wk.reduce((a,b)=>a+b.units,0);
      const L = state.settings.weeklyLimit||14;
      const thresholds = [0.5,1.0,1.5].map(p=>p*L);
      const crossed = thresholds.find(t => (weekU>=t && weekU< t+1)); // naive
      if(crossed!==undefined){
        new Notification("Alcohol Tracker", { body:`Milestone: ${weekU.toFixed(1)}u this week (${Math.round(weekU/L*100)}% of limit)` });
      }
    }

    // ---------- Presets & calculator ----------
    const presets = {
      beer_pint_4:      { label:"Pint Lager",  ml:568, abv:4.0 },
      wine_175_12:      { label:"Wine 175ml",  ml:175, abv:12.0 },
      wine_250_13:      { label:"Wine 250ml",  ml:250, abv:13.0 },
      spirit_double_40: { label:"Spirit Double", ml:50, abv:40.0 },
      cider_pint_4_5:   { label:"Cider Pint",  ml:568, abv:4.5 },
      alcopop_330_4:    { label:"Alcopop 330ml", ml:330, abv:4.0 },
      cocktail_est_2:   { label:"Cocktail (est.)", ml:0, abv:0, units:2.0 }
    };
    function presetUnits(key){
      const p = presets[key];
      return p.units !== undefined ? p.units : unitsFrom(p.abv, p.ml);
    }

    function updateCalcUnits(){
      const ml  = Number($("#drinkMl").value)||0;
      const abv = Number($("#drinkAbv").value)||0;
      $("#calcUnits").textContent = unitsFrom(abv, ml).toFixed(2);
    }

    // ---------- Reset helpers ----------
    function resetToday(){
      const key = dateKey(today());
      state.entries = state.entries.filter(e => dateKey(new Date(e.ts)) !== key);
      saveState(state); renderAll();
    }
    function resetWeek(){
      if(!confirm("Reset all entries in this week view?")) return;
      const keep = [];
      const keys = new Set(weeklyBuckets(state.settings.weekMode).map(x=>x.date));
      for(const e of state.entries){
        const k = dateKey(new Date(e.ts));
        if(!keys.has(k)) keep.push(e);
      }
      state.entries = keep;
      saveState(state); renderAll();
    }

    // ---------- Export/Import ----------
    function exportCSV(){
      const wk = weeklyBuckets(state.settings.weekMode);
      const rows = [["Date","Units"]];
      wk.forEach(r => rows.push([r.date, r.units]));
      // add today's date line to mirror legacy
      const blob = new Blob([rows.map(r=>r.join(",")).join("\n")], {type:"text/csv;charset=utf-8"});
      downloadBlob(blob, "weekly_history.csv");
    }
    function exportJSON(){
      const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
      downloadBlob(blob, "alcohol_tracker_export.json");
    }
    function downloadBlob(blob, name){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = name; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }
    function importJSONFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result);
          if(obj && obj.entries && obj.settings){
            state.entries = obj.entries;
            state.settings = Object.assign({}, defaults.settings, obj.settings);
            saveState(state); renderAll();
            alert("Import successful.");
          }else throw new Error("Invalid file");
        }catch(e){ alert("Import failed: " + e.message); }
      };
      reader.readAsText(file);
    }

    // ---------- State & Events ----------
    let state = loadState();

    // Controls initial fill
    $("#weeklyLimit").addEventListener("input", e=>{ state.settings.weeklyLimit = Math.max(0, Number(e.target.value)||0); saveState(state); renderAll(); });
    $("#weekMode").addEventListener("change", e=>{ state.settings.weekMode = e.target.value; saveState(state); renderAll(); });
    $("#pricePerUnit").addEventListener("input", e=>{ state.settings.pricePerUnit = Math.max(0, Number(e.target.value)||0); saveState(state); renderAll(); });
    $("#kcalPerUnit").addEventListener("input", e=>{ state.settings.kcalPerUnit = Math.max(0, Number(e.target.value)||0); saveState(state); renderAll(); });

    // Theme
    $("#toggleTheme").addEventListener("click",()=>{
      const cur = document.body.getAttribute("data-theme");
      const next = cur==="light" ? "dark" : "light";
      document.body.setAttribute("data-theme", next);
      $("#themeLabel").textContent = next==="dark" ? "Light" : "Dark";
      state.settings.theme = next; saveState(state);
    });

    // Presets click
    document.querySelectorAll("[data-preset]").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const id = btn.dataset.preset;
        const p = presets[id];
        const units = p.units !== undefined ? p.units : unitsFrom(p.abv, p.ml);
        addEntry(makeEntry({ label: p.label, ml: p.ml||0, abv: p.abv||0, units }));
      });
    });

    // Calculator bindings
    $("#drinkMl").addEventListener("input", updateCalcUnits);
    $("#drinkAbv").addEventListener("input", updateCalcUnits);
    $("#addDrink").addEventListener("click", ()=>{
      const ml  = Number($("#drinkMl").value)||0;
      const abv = Number($("#drinkAbv").value)||0;
      const label = ($("#drinkLabel").value||"Drink").trim();
      addEntry(makeEntry({ label, ml, abv }));
      $("#drinkLabel").value="";
    });

    // Manual adjust / undo
    $("#removeUnitsBtn").addEventListener("click", ()=>{
      const u = Number($("#manualUnits").value)||0;
      if(u<=0) return;
      addEntry(makeEntry({ label:"Manual remove", ml:0, abv:0, units: -Math.abs(u) }));
    });
    $("#undoBtn").addEventListener("click", ()=>{ if(state.entries.length){ undoLast(); } });

    // Resets
    $("#resetToday").addEventListener("click", ()=>{ if(confirm("Reset all entries today?")) resetToday(); });
    $("#resetWeek").addEventListener("click", resetWeek);

    // Export / Import
    $("#exportCSV").addEventListener("click", exportCSV);
    $("#exportJSON").addEventListener("click", exportJSON);
    $("#importBtn").addEventListener("click", ()=>$("#importJSON").click());
    $("#importJSON").addEventListener("change", e=>{
      const f = e.target.files?.[0]; if(f) importJSONFile(f);
      e.target.value="";
    });

    // Notifications
    $("#notifyBtn").addEventListener("click", ()=>{
      if(!("Notification" in window)) return alert("Notifications not supported");
      requestNotify();
    });

    // Initial render
    renderAll();

    // ---------- End IIFE ----------
  })();
  </script>
</body>
</html>
