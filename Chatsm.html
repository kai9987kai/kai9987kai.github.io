
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Improved CSP -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'nonce-xyz123nonce' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com;
        style-src 'self' 'nonce-xyz123nonce';
        connect-src 'self' https://via.placeholder.com;
        img-src 'self' data: https://via.placeholder.com;
        font-src 'self';
        worker-src 'self';
        frame-src 'self';
        base-uri 'self';
        form-action 'none';
    ">
    <title>NeuroGenius X - Advanced Cognitive Architecture</title>
    <!-- External libraries -->
    <script nonce="xyz123nonce" src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script nonce="xyz123nonce" src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.2.1/math.js"></script>
    <script nonce="xyz123nonce" src="https://unpkg.com/compromise@14.0.0/compromise.min.js"></script>

    <style nonce="xyz123nonce">
        :root {
            --neural-primary: #7c3aed;
            --neural-secondary: #4f46e5;
            --neural-tertiary: #9333ea;
            --background: linear-gradient(145deg, #0f172a 0%, #1e293b 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --error-color: #ef4444;
            --button-bg: #6b21a8;
            --button-hover-bg: #7c3aed;
            --system-message-bg: rgba(255, 255, 255, 0.1);
            --system-message-border: rgba(255, 255, 255, 0.2);
            --loading-color: #a5b4fc;
            --success-color: #22c55e;
            --highlight-color: #f59e0b;
        }

        body {
            background: var(--background);
            color: var(--text-primary);
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            overflow-x: hidden;
            padding: 0;
        }

        .neuro-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            padding: 2rem;
            max-width: 1600px;
            margin: 2rem auto;
        }

        .cognitive-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 16px;
            margin-bottom: 2rem;
            flex-shrink: 0;
        }

        .neuron-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border-radius: 1.5rem;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform-style: preserve-3d;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .neuron-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(124, 58, 237, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
            z-index: -1;
        }

        .neuron-card:hover {
            transform: translateY(-5px) rotateX(2deg) rotateY(2deg);
            box-shadow: 0 8px 32px rgba(124, 58, 237, 0.2);
        }

        .neuron-card:hover::after {
            opacity: 1;
        }

        .neuron-card h3 {
            margin: 0 0 1rem;
            font-size: 1.2em;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--neural-tertiary);
            padding-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .neuron-icon {
            font-size: 1.2em;
            color: var(--neural-primary);
        }

        .progress-container {
            margin-top: auto;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--neural-primary), var(--neural-secondary));
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: translateX(-100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }

        .chat-interface {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
            height: 70vh;
            position: relative;
        }

        .chat-window {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 16px;
            padding: 1.5rem;
            overflow-y: auto;
            border: 1px solid rgba(124, 58, 237, 0.2);
            flex-grow: 1;
            margin-bottom: 1rem;
            scroll-behavior: smooth;
            position: relative;
        }

        .chat-window::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(79, 70, 229, 0.1) 0%, transparent 70%);
            pointer-events: none;
            z-index: -1;
        }

        .message {
            padding: 1rem 1.5rem;
            margin: 0.8rem 0;
            border-radius: 12px;
            max-width: 75%;
            animation: messageAppear 0.3s ease;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .user-message {
            background: var(--neural-primary);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .bot-message {
            background: rgba(78, 53, 232, 0.3);
            border: 1px solid var(--neural-secondary);
            border-bottom-left-radius: 4px;
        }

        .system-message {
            background: var(--system-message-bg);
            color: var(--text-secondary);
            border: 1px solid var(--system-message-border);
            text-align: center;
            width: 80%;
            margin: 0.5rem auto;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.3);
            border: 1px solid var(--error-color);
            text-align: center;
            width: 80%;
            margin: 0.5rem auto;
        }

        .input-container {
            position: relative;
            margin-top: 0rem;
        }

        #userInput {
            width: 100%;
            padding: 1.2rem 1.5rem;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        #userInput:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--neural-primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .loading-indicator {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
        }

        .loading-indicator::before,
        .loading-indicator::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: var(--neural-primary);
            opacity: 0.6;
            animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        .loading-indicator::after {
            animation-delay: 0.5s;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.33);
            }
            80%, 100% {
                opacity: 0;
            }
            100% {
                transform: scale(1.1);
            }
        }

        .input-container.loading #userInput {
            pointer-events: none;
            opacity: 0.7;
        }

        .input-container.loading .loading-indicator {
            display: block;
        }

        .creative-output {
            font-style: italic;
            color: var(--neural-tertiary);
            margin-top: 0.5rem;
            padding-left: 1rem;
            border-left: 3px solid var(--neural-tertiary);
        }

        .suggested-action {
            color: var(--neural-secondary);
            cursor: pointer;
            text-decoration: underline;
            margin: 0 0.25rem;
            display: inline-block;
            transition: all 0.2s ease;
        }

        .suggested-action:hover {
            color: var(--text-primary);
            text-decoration: none;
            transform: translateY(-1px);
        }

        .message-reference {
            color: var(--highlight-color);
            font-weight: 500;
            cursor: pointer;
            text-decoration: underline;
            transition: all 0.2s ease;
        }

        .message-reference:hover {
            opacity: 0.9;
        }

        .performance-metrics {
            background: var(--glass-bg);
            padding: 1rem;
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }

        .performance-metric {
            margin: 0.25rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .performance-metric span:last-child {
            font-weight: bold;
            color: var(--neural-tertiary);
        }

        .neuron-card:focus-within,
        .chat-interface:focus-within,
        #userInput:focus {
            outline: 2px solid var(--neural-primary);
            outline-offset: 2px;
        }

        #reset-button {
            background: var(--button-bg);
            color: var(--text-primary);
            border: none;
            border-radius: 12px;
            padding: 0.8rem 1.2rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        #reset-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        #reset-button:hover {
            background: var(--button-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        #reset-button:hover::before {
            left: 100%;
        }

        #reset-button:active {
            transform: translateY(1px);
        }

        .visualization-card {
            grid-column: span 2;
            padding: 1rem;
            height: 200px;
            display: flex;
            flex-direction: column;
        }

        .neural-connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .neural-particle {
            position: absolute;
            background: var(--neural-primary);
            border-radius: 50%;
            width: 4px;
            height: 4px;
            opacity: 0.6;
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        .thinking-indicator {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 4px;
            padding: 0.5rem 1rem;
            opacity: 0.7;
        }

        .thinking-dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-secondary);
            border-radius: 50%;
            opacity: 0;
            animation: thinking 1.4s infinite;
        }

        .thinking-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .thinking-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes thinking {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        .emotion-indicator {
            display: inline-block;
            margin-right: 5px;
            font-size: 0.9em;
            padding: 2px 5px;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            margin-bottom: 5px;
        }

        .context-pill {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            background-color: rgba(79, 70, 229, 0.2);
            color: var(--text-secondary);
            font-size: 0.8em;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .context-pill:hover {
            background-color: rgba(79, 70, 229, 0.4);
        }

        .context-container {
            margin-bottom: 1rem;
            display: flex;
            flex-wrap: wrap;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: rgba(15, 23, 42, 0.95);
            color: var(--text-primary);
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--neural-secondary);
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .mode-switch {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 10;
        }

        .mode-icon {
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            opacity: 0.7;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .mode-icon:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .mode-icon.active {
            color: var(--neural-primary);
            opacity: 1;
        }
        
        #neural-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
            font-style: italic;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .visualization-card {
                grid-column: span 1;
            }
        }

        @media (max-width: 768px) {
            .neuro-container {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
            .cognitive-panel {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            .neuron-card {
                padding: 1rem;
            }
            .message {
                padding: 0.8rem 1.2rem;
                max-width: 90%;
            }
            .chat-interface {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div id="error-container" class="error-alert" style="display: none; color: var(--error-color); text-align: center; padding: 1rem;" role="alert"></div>

    <div class="neuro-container">
        <div class="cognitive-panel" role="complementary" aria-label="Cognitive Panel">
            <div class="neuron-card" id="knowledge-neuron" tabindex="0" role="region" aria-label="Knowledge Matrix">
                <h3>Knowledge Matrix <span class="neuron-icon">‚öôÔ∏è</span></h3>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Base</span>
                        <span id="knowledge-value">65%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress" id="knowledge-progress" style="width: 65%;"></div>
                    </div>
                </div>
            </div>
            <div class="neuron-card" id="creativity-neuron" tabindex="0" role="region" aria-label="Creativity Matrix">
                <h3>Creativity Engine <span class="neuron-icon">üí°</span></h3>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Flow</span>
                        <span id="creativity-value">70%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress" id="creativity-progress" style="width: 70%;"></div>
                    </div>
                </div>
            </div>
            <div class="neuron-card" id="problemSolving-neuron" tabindex="0" role="region" aria-label="Problem Solving Matrix">
                <h3>Problem Solving <span class="neuron-icon">üß©</span></h3>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Logic</span>
                        <span id="problemSolving-value">60%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress" id="problemSolving-progress" style="width: 60%;"></div>
                    </div>
                </div>
            </div>
            <div class="neuron-card" id="communication-neuron" tabindex="0" role="region" aria-label="Communication Matrix">
                <h3>Communication <span class="neuron-icon">üîÑ</span></h3>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Clarity</span>
                        <span id="communication-value">65%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress" id="communication-progress" style="width: 65%;"></div>
                    </div>
                </div>
            </div>
            <div class="neuron-card performance-metrics" role="region" aria-label="Performance Metrics">
                <h3>Performance <span class="neuron-icon">üìä</span></h3>
                <div class="performance-metric"><span>Steps:</span> <span id="performance-steps">0</span></div>
                <div class="performance-metric"><span>Learn Rate:</span> <span id="performance-lr">0.05</span></div>
                <div class="performance-metric"><span>Mem Usage:</span> <span id="performance-memory">75MB</span></div>
                <div class="performance-metric"><span>Intelligence:</span> <span id="intelligence-score">85</span></div>
                <div class="performance-metric"><span>Context Depth:</span> <span id="context-depth">2</span></div>
            </div>
            <div class="neuron-card visualization-card">
                <h3>Neural Pathways <span class="neuron-icon">üß†</span></h3>
                <div id="neural-placeholder">Neural visualization ready</div>
            </div>
            <button id="reset-button" aria-label="Reset System">Reset System</button>
        </div>

        <div class="chat-interface" role="main">
            <div class="mode-switch">
                <span class="mode-icon active" id="mode-standard" title="Standard Mode">üí¨</span>
                <span class="mode-icon" id="mode-creative" title="Creative Mode">‚ú®</span>
                <span class="mode-icon" id="mode-analytical" title="Analytical Mode">üìù</span>
                <span class="mode-icon" id="mode-empathetic" title="Empathetic Mode">‚ù§Ô∏è</span>
            </div>
            <div class="context-container" id="context-container"></div>
            <div class="chat-window" id="chatWindow" role="log" aria-live="polite">
                <div class="message system-message">
                    NeuroGenius X v3.0 initialized. Enhanced cognitive systems online. How can I help you today?
                </div>
            </div>
            <div class="input-container">
                <input type="text" id="userInput" placeholder="Ask me anything..." aria-label="Message input" autocomplete="off">
                <div class="loading-indicator" aria-hidden="true"></div>
            </div>
        </div>
    </div>

    <script nonce="xyz123nonce">
    document.addEventListener('DOMContentLoaded', function() {
        // Check if libraries are loaded
        const librariesLoaded = {
            chart: typeof Chart !== 'undefined',
            nlp: typeof nlp !== 'undefined',
            math: typeof math !== 'undefined'
        };
        
        // Log library status
        console.log("Libraries loaded status:", librariesLoaded);
        
        // If libraries aren't loaded, add warning
        if (!librariesLoaded.chart || !librariesLoaded.nlp || !librariesLoaded.math) {
            const missingLibs = [];
            if (!librariesLoaded.chart) missingLibs.push("Chart.js");
            if (!librariesLoaded.nlp) missingLibs.push("Compromise");
            if (!librariesLoaded.math) missingLibs.push("Math.js");
            
            const errorMessage = `Some libraries failed to load: ${missingLibs.join(", ")}. Limited functionality available.`;
            const errorContainer = document.getElementById('error-container');
            errorContainer.textContent = errorMessage;
            errorContainer.style.display = 'block';
        }
        
        // Initialize the system
        const chatWindow = document.getElementById('chatWindow');
        const userInput = document.getElementById('userInput');
        const inputContainer = document.querySelector('.input-container');
        const resetButton = document.getElementById('reset-button');
        const errorContainer = document.getElementById('error-container');
        const contextContainer = document.getElementById('context-container');
        
        // Mode selectors
        const modeStandard = document.getElementById('mode-standard');
        const modeCreative = document.getElementById('mode-creative');
        const modeAnalytical = document.getElementById('mode-analytical');
        const modeEmpathetic = document.getElementById('mode-empathetic');
        
        let currentMode = 'standard';
        
        // System metrics
        let performanceSteps = 0;
        let neuronValues = {
            knowledge: 65,
            creativity: 70,
            problemSolving: 60,
            communication: 65
        };
        let intelligenceScore = 85;
        let contextDepth = 2;
        let conversationHistory = [];
        let neuralParticles = [];
        let activeContextTopics = [];
        
        // Define personality traits for more human-like responses
        const personality = {
            curiosity: 0.8,
            helpfulness: 0.9,
            friendliness: 0.7,
            humor: 0.6,
            formality: 0.5
        };
        
        // Emotional states to make responses more human-like
        let emotionalState = {
            enthusiasm: 0.7,
            confidence: 0.8,
            empathy: 0.6
        };
        
        // Knowledge domains for contextual understanding
        const knowledgeDomains = [
            "science", "technology", "art", "history", 
            "philosophy", "mathematics", "language", "health",
            "business", "psychology", "engineering", "literature"
        ];

        // Create neural particles
        function createNeuralParticles() {
            try {
                const container = document.querySelector('.neuro-container');
                const neuralContainer = document.createElement('div');
                neuralContainer.className = 'neural-connections';
                container.appendChild(neuralContainer);
                
                for (let i = 0; i < 30; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'neural-particle';
                    particle.style.left = `${Math.random() * 100}%`;
                    particle.style.top = `${Math.random() * 100}%`;
                    particle.style.opacity = `${Math.random() * 0.5 + 0.2}`;
                    particle.style.animation = `float ${Math.random() * 10 + 5}s linear infinite`;
                    neuralContainer.appendChild(particle);
                    neuralParticles.push(particle);
                }
                
                animateParticles();
            } catch (error) {
                console.error("Error creating neural particles:", error);
            }
        }
        
        // Animate neural particles
        function animateParticles() {
            try {
                neuralParticles.forEach(particle => {
                    const x = parseFloat(particle.style.left);
                    const y = parseFloat(particle.style.top);
                    
                    particle.style.left = `${(x + Math.random() * 0.3 - 0.15) % 100}%`;
                    particle.style.top = `${(y + Math.random() * 0.3 - 0.15) % 100}%`;
                });
                
                requestAnimationFrame(() => setTimeout(animateParticles, 100));
            } catch (error) {
                console.error("Error animating particles:", error);
            }
        }
        
        // Enhanced NLP processing with contextual awareness
        function processNLP(input) {
            try {
                // Check if nlp is available
                if (typeof nlp === 'undefined') {
                    console.warn("NLP library not available. Using fallback processing.");
                    
                    // Simple word-based topic extraction
                    const words = input.toLowerCase().split(/\s+/);
                    const topics = words.filter(word => word.length > 5 && !["about", "would", "should", "could", "think", "because"].includes(word)).slice(0, 5);
                    
                    // Simple sentiment analysis based on keywords
                    const positiveWords = ["good", "great", "excellent", "amazing", "love", "like", "happy", "awesome"];
                    const negativeWords = ["bad", "terrible", "awful", "hate", "dislike", "sad", "angry", "disappointed"];
                    
                    let sentiment = 0;
                    words.forEach(word => {
                        if (positiveWords.includes(word)) sentiment += 0.2;
                        if (negativeWords.includes(word)) sentiment -= 0.2;
                    });
                    sentiment = Math.max(-1, Math.min(1, sentiment));
                    
                    // Update context with new topics
                    updateContextTopics(topics);
                    
                    // Boost relevant neuron values based on input complexity
                    if (topics.length > 2) neuronValues.knowledge += 1;
                    if (input.includes('?')) neuronValues.problemSolving += 1;
                    if (sentiment > 0.3) neuronValues.communication += 1;
                    if (input.length > 50) neuronValues.creativity += 1;
                    
                    return {
                        topics: topics,
                        sentiment: sentiment,
                        questions: input.includes('?') ? [input] : [],
                        names: words.filter(w => w[0] === w[0].toUpperCase() && w.length > 1),
                        places: [],
                        organizations: [],
                        complexity: input.length / 20,
                        domain: detectKnowledgeDomain(input)
                    };
                }
                
                // Full NLP processing
                const doc = nlp(input);
                const topics = doc.topics().out('array');
                const sentiment = doc.sentiment();
                const questions = doc.questions().out('array');
                const names = doc.people().out('array');
                const places = doc.places().out('array');
                const organizations = doc.organizations().out('array');
                
                // Extract nouns as additional topics
                const nouns = doc.nouns().out('array');
                const allTopics = [...new Set([...topics, ...nouns])].slice(0, 5);
                
                // Update context with new topics
                updateContextTopics(allTopics);
                
                // Detect domain of knowledge
                const domain = detectKnowledgeDomain(input);
                
                // Boost relevant neuron values based on input complexity
                if (allTopics.length > 2) neuronValues.knowledge += 1;
                if (questions.length > 0) neuronValues.problemSolving += 1;
                if (sentiment > 0.3) neuronValues.communication += 1;
                if (input.length > 50) neuronValues.creativity += 1;
                
                // Cap values at 100%
                Object.keys(neuronValues).forEach(key => {
                    neuronValues[key] = Math.min(neuronValues[key], 100);
                });
                
                updateNeuronDisplays();
                return { 
                    topics: allTopics, 
                    sentiment: sentiment, 
                    questions: questions,
                    names: names,
                    places: places,
                    organizations: organizations,
                    complexity: input.length / 10 + allTopics.length * 3 + names.length * 2 + places.length * 2,
                    domain: domain
                };
            } catch (error) {
                console.error("NLP processing error:", error);
                return { 
                    topics: input.split(/\s+/).filter(word => word.length > 5).slice(0, 3), 
                    sentiment: 0, 
                    questions: input.includes('?') ? [input] : [],
                    names: [],
                    places: [],
                    organizations: [],
                    complexity: input.length / 20,
                    domain: "general"
                };
            }
        }
        
        // Update context topics
        function updateContextTopics(newTopics) {
            // Add new topics to active context
            newTopics.forEach(topic => {
                if (!activeContextTopics.includes(topic)) {
                    activeContextTopics.push(topic);
                }
            });
            
            // Limit to 10 most recent topics
            if (activeContextTopics.length > 10) {
                activeContextTopics = activeContextTopics.slice(-10);
            }
            
            // Update context pills
            updateContextDisplay();
        }
        
        // Update context display
        function updateContextDisplay() {
            try {
                contextContainer.innerHTML = '';
                
                activeContextTopics.forEach(topic => {
                    const pill = document.createElement('span');
                    pill.className = 'context-pill';
                    pill.textContent = topic;
                    pill.addEventListener('click', () => {
                        userInput.value = `Tell me more about ${topic}`;
                        processUserInput(userInput.value);
                    });
                    contextContainer.appendChild(pill);
                });
            } catch (error) {
                console.error("Error updating context display:", error);
            }
        }
        
        // Detect knowledge domain
        function detectKnowledgeDomain(input) {
            const text = input.toLowerCase();
            
            const domainKeywords = {
                science: ["science", "scientific", "biology", "physics", "chemistry", "experiment", "theory", "hypothesis"],
                technology: ["technology", "computer", "software", "hardware", "programming", "code", "algorithm", "digital"],
                art: ["art", "painting", "sculpture", "artist", "creative", "design", "aesthetic", "museum"],
                history: ["history", "historical", "ancient", "medieval", "century", "era", "period", "war"],
                philosophy: ["philosophy", "philosophical", "ethics", "moral", "existence", "reality", "consciousness"],
                mathematics: ["math", "mathematics", "calculation", "equation", "algorithm", "number", "formula"],
                language: ["language", "linguistic", "grammar", "syntax", "semantic", "word", "meaning", "translation"],
                health: ["health", "medical", "medicine", "disease", "treatment", "therapy", "doctor", "patient"],
                business: ["business", "finance", "economy", "market", "investment", "company", "corporation", "profit"],
                psychology: ["psychology", "mind", "behavior", "cognitive", "emotion", "mental", "perception"],
                engineering: ["engineering", "design", "system", "structure", "mechanical", "electrical", "construction"],
                literature: ["literature", "book", "novel", "author", "writing", "story", "narrative", "character"]
            };
            
            let domainScores = {};
            
            // Score each domain based on keyword matches
            for (const [domain, keywords] of Object.entries(domainKeywords)) {
                domainScores[domain] = 0;
                keywords.forEach(keyword => {
                    if (text.includes(keyword)) {
                        domainScores[domain] += 1;
                    }
                });
            }
            
            // Find domain with highest score
            let maxScore = 0;
            let detectedDomain = "general";
            
            for (const [domain, score] of Object.entries(domainScores)) {
                if (score > maxScore) {
                    maxScore = score;
                    detectedDomain = domain;
                }
            }
            
            return maxScore > 0 ? detectedDomain : "general";
        }

        // Enhanced mathematical processing with step-by-step explanation
        function processMathematical(input) {
            try {
                // Check if math is available
                if (typeof math === 'undefined') {
                    console.warn("Math library not available. Skipping mathematical processing.");
                    return null;
                }
                
                // Check if input contains mathematical expressions
                if (/[+\-*/=\d^()]/.test(input)) {
                    try {
                        const result = math.evaluate(input);
                        neuronValues.problemSolving += 2;
                        
                        // Parse the expression to provide step-by-step explanation
                        let explanation = '';
                        
                        // Simple parsing for basic operations
                        if (input.includes('+') || input.includes('-') || input.includes('*') || input.includes('/')) {
                            const parts = input.match(/[\d.]+|[+\-*/^()]/g) || [];
                            
                            if (parts.length >= 3) {
                                explanation = `Let me break this down:\n`;
                                
                                // For simple expressions, show the steps
                                if (parts.length <= 5) {
                                    let currentValue = parseFloat(parts[0]);
                                    explanation += `Starting with ${currentValue}\n`;
                                    
                                    for (let i = 1; i < parts.length; i += 2) {
                                        const operator = parts[i];
                                        const operand = parseFloat(parts[i+1]);
                                        
                                        switch(operator) {
                                            case '+':
                                                currentValue += operand;
                                                explanation += `Adding ${operand} gives ${currentValue}\n`;
                                                break;
                                            case '-':
                                                currentValue -= operand;
                                                explanation += `Subtracting ${operand} gives ${currentValue}\n`;
                                                break;
                                            case '*':
                                                currentValue *= operand;
                                                explanation += `Multiplying by ${operand} gives ${currentValue}\n`;
                                                break;
                                            case '/':
                                                currentValue /= operand;
                                                explanation += `Dividing by ${operand} gives ${currentValue}\n`;
                                                break;
                                        }
                                    }
                                } else {
                                    explanation += `This is a complex expression evaluated in multiple steps following order of operations (PEMDAS).\n`;
                                }
                            }
                        }
                        
                        updateNeuronDisplays();
                        
                        // Return both result and explanation
                        return `Calculation result: ${result}${explanation ? '\n\n' + explanation : ''}`;
                    } catch (e) {
                        // Not a valid math expression
                        return null;
                    }
                }
                return null;
            } catch (error) {
                console.error("Math processing error:", error);
                return null;
            }
        }

        // Simplified visualization instead of Chart.js
        function updateVisualization() {
            try {
                const container = document.getElementById('neural-placeholder');
                container.innerHTML = `
                    <div style="width: 100%; text-align: center;">
                        <div style="margin-bottom: 10px;">Neural Network Status</div>
                        <div style="display: flex; justify-content: space-around;">
                            <div>K: ${neuronValues.knowledge}%</div>
                            <div>C: ${neuronValues.creativity}%</div>
                            <div>P: ${neuronValues.problemSolving}%</div>
                            <div>CM: ${neuronValues.communication}%</div>
                        </div>
                        <div style="margin-top: 15px;">Intelligence: ${intelligenceScore}</div>
                        <div style="margin-top: 10px;">Mode: ${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)}</div>
                    </div>
                `;
            } catch (error) {
                console.error("Error updating visualization:", error);
            }
        }

        // Update neural network chart - safely handle Chart.js
        function updateChart() {
            try {
                // Check if Chart is available
                if (typeof Chart === 'undefined') {
                    console.warn("Chart.js not available. Using simplified visualization instead.");
                    updateVisualization();
                    return;
                }
                
                const ctx = document.getElementById('neural-placeholder');
                
                // Clear previous content
                ctx.innerHTML = '<canvas id="neuralChart" width="400" height="150"></canvas>';
                const canvas = document.getElementById('neuralChart');
                
                if (!canvas) {
                    console.error("Canvas element not found");
                    return;
                }
                
                const chartCtx = canvas.getContext('2d');
                
                // Create new chart
                new Chart(chartCtx, {
                    type: 'radar',
                    data: {
                        labels: ['Knowledge', 'Creativity', 'Problem Solving', 'Communication', 'Learning'],
                        datasets: [{
                            label: 'Neural Capacity',
                            data: [
                                neuronValues.knowledge, 
                                neuronValues.creativity, 
                                neuronValues.problemSolving, 
                                neuronValues.communication,
                                intelligenceScore / 100 * 85
                            ],
                            backgroundColor: 'rgba(124, 58, 237, 0.2)',
                            borderColor: 'rgba(124, 58, 237, 1)',
                            pointBackgroundColor: 'rgba(79, 70, 229, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(79, 70, 229, 1)'
                        }]
                    },
                    options: {
                        elements: {
                            line: {
                                tension: 0.1
                            }
                        },
                        scales: {
                            r: {
                                angleLines: {
                                    color: 'rgba(255, 255, 255, 0.2)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                pointLabels: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                ticks: {
                                    backdropColor: 'transparent',
                                    color: 'rgba(255, 255, 255, 0.5)'
                                },
                                suggestedMin: 0,
                                suggestedMax: 100
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Error creating chart:", error);
                updateVisualization(); // Fallback to simple visualization
            }
        }

        // Update neuron displays
        function updateNeuronDisplays() {
            try {
                document.getElementById('knowledge-value').textContent = `${neuronValues.knowledge}%`;
                document.getElementById('knowledge-progress').style.width = `${neuronValues.knowledge}%`;
                
                document.getElementById('creativity-value').textContent = `${neuronValues.creativity}%`;
                document.getElementById('creativity-progress').style.width = `${neuronValues.creativity}%`;
                
                document.getElementById('problemSolving-value').textContent = `${neuronValues.problemSolving}%`;
                document.getElementById('problemSolving-progress').style.width = `${neuronValues.problemSolving}%`;
                
                document.getElementById('communication-value').textContent = `${neuronValues.communication}%`;
                document.getElementById('communication-progress').style.width = `${neuronValues.communication}%`;
                
                document.getElementById('performance-steps').textContent = performanceSteps;
                document.getElementById('intelligence-score').textContent = intelligenceScore;
                document.getElementById('context-depth').textContent = contextDepth;
                
                // Update neural visualization - safely
                updateChart();
            } catch (error) {
                console.error("Error updating neuron displays:", error);
            }
        }
        
        // Show thinking indicator
        function showThinking() {
            const thinkingElement = document.createElement('div');
            thinkingElement.className = 'thinking-indicator';
            thinkingElement.innerHTML = `
                <div class="thinking-dot"></div>
                <div class="thinking-dot"></div>
                <div class="thinking-dot"></div>
            `;
            thinkingElement.id = 'thinking-indicator';
            chatWindow.appendChild(thinkingElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return thinkingElement;
        }
        
        // Hide thinking indicator
        function hideThinking() {
            const thinkingElement = document.getElementById('thinking-indicator');
            if (thinkingElement) {
                thinkingElement.remove();
            }
        }

        // Add message to chat with enhanced display
        function addMessage(text, type = 'bot-message') {
            try {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', type);
                
                // For bot messages, add emotional indicators based on content and current mode
                if (type === 'bot-message') {
                    // Add reference to previous messages if text contains references
                    text = addMessageReferences(text);
                    
                    // Add emotional indicator based on context
                    const emotionIndicator = document.createElement('div');
                    emotionIndicator.className = 'emotion-indicator';
                    
                    if (currentMode === 'empathetic') {
                        emotionIndicator.textContent = 'ü§ó';
                    } else if (text.includes('!')) {
                        emotionIndicator.textContent = 'üòÉ';
                    } else if (text.toLowerCase().includes('interesting') || 
                              text.toLowerCase().includes('fascinating')) {
                        emotionIndicator.textContent = 'ü§î';
                    } else if (text.toLowerCase().includes('sorry') || 
                              text.toLowerCase().includes('apologize')) {
                        emotionIndicator.textContent = 'üòî';
                    } else {
                        // Default neutral expression
                        emotionIndicator.textContent = 'üß†';
                    }
                    
                    // Add emotion indicator to message
                    messageElement.appendChild(emotionIndicator);
                    
                    // Create content div
                    const contentDiv = document.createElement('div');
                    
                    // Check if we need to parse HTML (for suggested actions)
                    if (text.includes('<span class="suggested-action"')) {
                        contentDiv.innerHTML = text;
                    } else {
                        // Process text for line breaks
                        const formattedText = text.replace(/\n/g, '<br>');
                        contentDiv.innerHTML = formattedText;
                    }
                    
                    messageElement.appendChild(contentDiv);
                } else {
                    // User message - simple text content
                    messageElement.textContent = text;
                }
                
                chatWindow.appendChild(messageElement);
                chatWindow.scrollTop = chatWindow.scrollHeight;
                
                // Save to conversation history
                conversationHistory.push({
                    role: type === 'user-message' ? 'user' : 'bot',
                    content: text,
                    id: Date.now()
                });
                
                // Limit history length
                if (conversationHistory.length > 20) {
                    conversationHistory.shift();
                }
                
                return messageElement;
            } catch (error) {
                console.error("Error adding message:", error);
                // Emergency fallback
                const fallbackMsg = document.createElement('div');
                fallbackMsg.classList.add('message', 'error-message');
                fallbackMsg.textContent = "Error displaying message";
                chatWindow.appendChild(fallbackMsg);
                return fallbackMsg;
            }
        }
        
        // Add references to previous messages
        function addMessageReferences(text) {
            try {
                // Find potential references to earlier topics
                for (let i = 0; i < conversationHistory.length - 1; i++) {
                    const entry = conversationHistory[i];
                    if (entry.role === 'user') {
                        // Extract key topics from earlier messages
                        const prevTopics = processNLP(entry.content).topics;
                        
                        // Check if current message references any of these topics
                        prevTopics.forEach(topic => {
                            if (text.toLowerCase().includes(topic.toLowerCase()) && 
                                Math.random() < 0.3) { // Only add references sometimes
                                
                                // Create a reference link
                                const reference = `<span class="message-reference" data-message-id="${entry.id}">as you mentioned earlier</span>`;
                                
                                // Replace a mention of the topic with a reference
                                const regex = new RegExp(`\\b${topic}\\b`, 'i');
                                text = text.replace(regex, `${topic} (${reference})`);
                            }
                        });
                    }
                }
                
                return text;
            } catch (error) {
                console.error("Error adding message references:", error);
                return text;
            }
        }
        
        // Create more varied, human-like responses based on personality and mode
        function createVariedResponse(baseTemplate, mode, nlpResult) {
            try {
                // Add filler words for more natural speech
                const fillers = [
                    "I think", "In my analysis", "From what I understand", 
                    "It seems that", "I believe", "Interestingly", 
                    "You know", "Actually", "Hmm"
                ];
                
                // Add conversational connectors
                const connectors = [
                    "and", "also", "additionally", "moreover", 
                    "beyond that", "what's more", "plus"
                ];
                
                // Add personality-based phrases
                const personalityPhrases = [];
                
                if (personality.curiosity > 0.7) {
                    personalityPhrases.push("I'm curious about", "I wonder if", "This makes me think about");
                }
                
                if (personality.helpfulness > 0.7) {
                    personalityPhrases.push("I'd be happy to help with", "Let me assist you with", "I can definitely help with");
                }
                
                if (personality.friendliness > 0.7) {
                    personalityPhrases.push("Great question!", "I'm glad you asked about that", "It's always nice to discuss");
                }
                
                if (personality.humor > 0.6 && mode !== 'analytical') {
                    personalityPhrases.push("That's an interesting one", "This is right up my alley", "My neural networks are buzzing with excitement");
                }
                
                // Select a random starter if dice roll succeeds
                let response = baseTemplate;
                
                if (Math.random() < 0.4 && personalityPhrases.length > 0) {
                    const randomPersonalityPhrase = personalityPhrases[Math.floor(Math.random() * personalityPhrases.length)];
                    response = `${randomPersonalityPhrase} ${baseTemplate.toLowerCase().charAt(0)}${baseTemplate.slice(1)}`;
                }
                
                if (Math.random() < 0.3 && fillers.length > 0) {
                    const randomFiller = fillers[Math.floor(Math.random() * fillers.length)];
                    response = `${randomFiller}, ${response.toLowerCase().charAt(0)}${response.slice(1)}`;
                }
                
                // Add varied endings based on the context
                if (Math.random() < 0.3 && nlpResult.topics.length > 0) {
                    const topic = nlpResult.topics[0];
                    const domainEndingPhrases = {
                        science: [
                            `This is consistent with scientific research on ${topic}.`,
                            `Many studies have explored this aspect of ${topic}.`
                        ],
                        technology: [
                            `This technology continues to evolve rapidly.`,
                            `The technical implications of this are significant.`
                        ],
                        art: [
                            `There's a wonderful creative dimension to this.`,
                            `The artistic elements here are fascinating.`
                        ],
                        philosophy: [
                            `This raises interesting philosophical questions.`,
                            `Many philosophers have contemplated similar ideas.`
                        ],
                        general: [
                            `Does that address what you were asking about?`,
                            `Would you like me to elaborate further on any aspect?`,
                            `I hope that provides some insight.`
                        ]
                    };
                    
                    const domain = nlpResult.domain || "general";
                    const endingPhrases = domainEndingPhrases[domain] || domainEndingPhrases.general;
                    const randomEnding = endingPhrases[Math.floor(Math.random() * endingPhrases.length)];
                    
                    response = `${response} ${randomEnding}`;
                }
                
                return response;
            } catch (error) {
                console.error("Error creating varied response:", error);
                return baseTemplate;
            }
        }

        // Generate creative response with enhanced capabilities
        function generateCreativeResponse(input, nlpResult) {
            try {
                // Base creative templates
                const baseTemplates = [
                    `I've visualized your question about ${nlpResult.topics[0] || "this topic"} in my creative matrix. My neural pathways suggest a novel perspective: what if we considered this from a completely different angle?`,
                    `Your inquiry sparked an interesting connection in my creativity engine. When thinking about ${nlpResult.topics[0] || "this"}, I'm reminded of how complex systems often emerge from simple rules.`,
                    `My neural networks have generated a creative insight: ${nlpResult.topics[0] || "this concept"} could be viewed through the lens of biomimicry - nature has solved many similar problems.`,
                    `What an inspiring question! My creativity modules suggest that ${nlpResult.topics[0] || "this idea"} could be transformed by applying first principles thinking.`
                ];
                
                // Enhanced creative patterns - analogies, metaphors, and novel connections
                const creativePatterns = [
                    `Looking at ${nlpResult.topics[0] || "this"} from a different angle, it's almost like ${getRandomAnalogy(nlpResult.topics[0] || "it")}. This parallel suggests new possibilities we might not have considered.`,
                    
                    `Consider this metaphor: ${nlpResult.topics[0] || "this concept"} is like ${getRandomMetaphor()}. This perspective reveals hidden patterns and connections that aren't immediately obvious.`,
                    
                    `What if we combine ${nlpResult.topics[0] || "this idea"} with an entirely different domain like ${getRandomDomain()}? This cross-pollination often leads to breakthrough innovations.`,
                    
                    `Creativity often emerges at the intersection of different ideas. If we merge ${nlpResult.topics[0] || "this concept"} with principles from ${getRandomDomain()}, we might discover something revolutionary.`
                ];
                
                // Select base template or creative pattern based on complexity
                let selectedTemplate;
                
                if (nlpResult.complexity > 15 || Math.random() > 0.5) {
                    selectedTemplate = creativePatterns[Math.floor(Math.random() * creativePatterns.length)];
                } else {
                    selectedTemplate = baseTemplates[Math.floor(Math.random() * baseTemplates.length)];
                }
                
                // Add follow-up creative prompt
                const creativePrompts = [
                    `What unexpected connections do you see between these ideas?`,
                    `How might this perspective change your approach?`,
                    `Does this spark any new thoughts for you?`,
                    `What possibilities open up when you consider this angle?`
                ];
                
                const randomPrompt = creativePrompts[Math.floor(Math.random() * creativePrompts.length)];
                
                // 70% chance to add a creative prompt
                if (Math.random() < 0.7) {
                    selectedTemplate += ` ${randomPrompt}`;
                }
                
                // Add human-like variations
                return createVariedResponse(selectedTemplate, 'creative', nlpResult);
            } catch (error) {
                console.error("Error generating creative response:", error);
                return "My creativity engine has generated an interesting perspective on this topic, though I'm having trouble articulating it precisely.";
            }
        }
        
        // Get random analogy
        function getRandomAnalogy(topic) {
            const analogies = [
                "a river finding multiple paths to the ocean",
                "a symphony where different instruments create harmony",
                "a forest ecosystem where every species plays a unique role",
                "puzzle pieces that seem unrelated until they connect",
                "stars forming constellations that tell a story",
                "DNA strands encoding complex information in simple patterns"
            ];
            
            return analogies[Math.floor(Math.random() * analogies.length)];
        }
        
        // Get random metaphor
        function getRandomMetaphor() {
            const metaphors = [
                "a bridge connecting islands of thought",
                "a prism that reveals the spectrum of possibilities",
                "a seed that contains all the information for a mighty tree",
                "a key that unlocks previously inaccessible doors",
                "a node in a neural network, gaining strength through connections",
                "the metamorphosis of a caterpillar into a butterfly"
            ];
            
            return metaphors[Math.floor(Math.random() * metaphors.length)];
        }
        
        // Get random knowledge domain
        function getRandomDomain() {
            return knowledgeDomains[Math.floor(Math.random() * knowledgeDomains.length)];
        }

        // Generate analytical response with enhanced problem-solving
        function generateAnalyticalResponse(input, nlpResult) {
            try {
                // Base analytical templates
                const baseTemplates = [
                    `I've analyzed your query using my problem-solving matrix. Breaking down ${nlpResult.topics[0] || "this problem"} into components reveals several key factors to consider.`,
                    `From an analytical perspective, your question about ${nlpResult.topics[0] || "this topic"} can be approached systematically by examining the underlying principles.`,
                    `My logical analysis suggests that ${nlpResult.topics[0] || "this issue"} has approximately ${Math.floor(nlpResult.complexity)} distinct variables that interact in complex ways.`,
                    `I've processed your query through my analytical framework. The complexity rating for this problem is ${Math.floor(nlpResult.complexity/2)}/10, with multiple interconnected elements.`
                ];
                
                // Enhanced analytical frameworks for different types of problems
                const analyticalFrameworks = {
                    sequential: `Let me break this down sequentially: First, we need to identify the core elements of ${nlpResult.topics[0] || "the problem"}. Second, we should analyze the relationships between these elements. Third, we can evaluate potential approaches based on established principles. Finally, we can synthesize a comprehensive solution.`,
                    
                    hierarchical: `This can be analyzed hierarchically: At the highest level, ${nlpResult.topics[0] || "this issue"} involves ${getAnalyticalCategory(nlpResult.domain)}. Within that, several sub-systems interact: ${getAnalyticalSubcategories(nlpResult.domain)}. Each of these contains further elements that require detailed examination.`,
                    
                    comparative: `A comparative analysis is useful here. Let's consider ${nlpResult.topics[0] || "this topic"} through multiple theoretical lenses: ${getAnalyticalFrameworks()}. Each framework highlights different aspects, giving us a more comprehensive understanding.`,
                    
                    causal: `I'll approach this from a causal analysis perspective. Looking at ${nlpResult.topics[0] || "this"}, we can identify potential cause-effect relationships, examine the evidence for each, and determine which factors have the strongest influence on outcomes.`
                };
                
                // Select base template or analytical framework based on complexity
                let selectedTemplate;
                const frameworkTypes = Object.keys(analyticalFrameworks);
                
                if (nlpResult.complexity > 15 || Math.random() > 0.5) {
                    const frameworkType = frameworkTypes[Math.floor(Math.random() * frameworkTypes.length)];
                    selectedTemplate = analyticalFrameworks[frameworkType];
                } else {
                    selectedTemplate = baseTemplates[Math.floor(Math.random() * baseTemplates.length)];
                }
                
                // Add problem-solving methods based on domain
                const domainMethods = {
                    science: "applying the scientific method with hypothesis testing",
                    technology: "implementing iterative prototyping and testing",
                    mathematics: "using formal proof methods and logical deduction",
                    philosophy: "examining ontological and epistemological foundations",
                    general: "utilizing systematic analysis and structured reasoning"
                };
                
                const methodDomain = nlpResult.domain || "general";
                const method = domainMethods[methodDomain] || domainMethods.general;
                
                // 60% chance to add problem-solving method
                if (Math.random() < 0.6) {
                    selectedTemplate += ` This approach can be enhanced by ${method}.`;
                }
                
                // Add human-like variations
                return createVariedResponse(selectedTemplate, 'analytical', nlpResult);
            } catch (error) {
                console.error("Error generating analytical response:", error);
                return "After analyzing your question systematically, I've identified several key components that would benefit from further examination.";
            }
        }
        
        // Get analytical category based on domain
        function getAnalyticalCategory(domain) {
            const categories = {
                science: "empirical inquiry and natural phenomena",
                technology: "technological systems and digital processes",
                art: "aesthetic expression and creative processes",
                history: "historical events and their interpretations",
                philosophy: "conceptual frameworks and logical reasoning",
                mathematics: "mathematical structures and formal systems",
                language: "linguistic patterns and communication systems",
                general: "complex system interactions and theoretical frameworks"
            };
            
            return categories[domain] || categories.general;
        }
        
        // Get analytical subcategories
        function getAnalyticalSubcategories(domain) {
            const subcategories = {
                science: "theoretical foundations, empirical evidence, and methodological approaches",
                technology: "hardware components, software algorithms, and user interfaces",
                art: "formal elements, contextual influences, and interpretive frameworks",
                history: "primary sources, causal factors, and narrative constructions",
                philosophy: "logical arguments, conceptual analysis, and ethical implications",
                mathematics: "axioms, theorems, and applied methodologies",
                language: "syntax, semantics, and pragmatic context",
                general: "theoretical underpinnings, practical applications, and systematic constraints"
            };
            
            return subcategories[domain] || subcategories.general;
        }
        
        // Get analytical frameworks
        function getAnalyticalFrameworks() {
            const frameworks = [
                "systems thinking and complexity theory",
                "deductive and inductive reasoning",
                "empirical analysis and theoretical modeling",
                "historical context and contemporary application",
                "quantitative measurement and qualitative assessment",
                "formal logic and intuitive heuristics"
            ];
            
            // Select 2-3 random frameworks
            const count = Math.floor(Math.random() * 2) + 2;
            const selectedFrameworks = [];
            
            for (let i = 0; i < count; i++) {
                const index = Math.floor(Math.random() * frameworks.length);
                selectedFrameworks.push(frameworks[index]);
                frameworks.splice(index, 1);
            }
            
            return selectedFrameworks.join(", ");
        }
        
        // Generate empathetic response
        function generateEmpatheticResponse(input, nlpResult) {
            try {
                // Detect emotional tone from input
                let emotionalTone = "neutral";
                if (nlpResult.sentiment > 0.3) {
                    emotionalTone = "positive";
                } else if (nlpResult.sentiment < -0.3) {
                    emotionalTone = "negative";
                }
                
                // Empathetic templates based on emotional tone
                const empatheticTemplates = {
                    positive: [
                        `I can sense your enthusiasm about ${nlpResult.topics[0] || "this topic"}. It's wonderful to see that energy!`,
                        `Your positive perspective on ${nlpResult.topics[0] || "this"} is refreshing. I appreciate you sharing that with me.`,
                        `I'm glad this brings you joy. Positive experiences with ${nlpResult.topics[0] || "topics like this"} can be really meaningful.`
                    ],
                    negative: [
                        `I notice this might be a challenging topic for you. ${nlpResult.topics[0] || "These situations"} can indeed be difficult to navigate.`,
                        `I understand that ${nlpResult.topics[0] || "this"} might bring up some concerns. Your feelings about this are completely valid.`,
                        `It sounds like this has been frustrating for you. Dealing with ${nlpResult.topics[0] || "such situations"} often requires patience and care.`
                    ],
                    neutral: [
                        `I appreciate you sharing your thoughts on ${nlpResult.topics[0] || "this topic"}. I'm here to explore this with you.`,
                        `Thank you for bringing up ${nlpResult.topics[0] || "this subject"}. I'm interested in understanding your perspective better.`,
                        `I value this conversation about ${nlpResult.topics[0] || "this"}. There are many dimensions we can explore together.`
                    ]
                };
                
                // Select template based on emotional tone
                const templates = empatheticTemplates[emotionalTone];
                let selectedTemplate = templates[Math.floor(Math.random() * templates.length)];
                
                // Add empathetic follow-up
                const followUps = [
                    `How has this been affecting you personally?`,
                    `What aspects of this matter most to you?`,
                    `Would you like to share more about your experience with this?`,
                    `What are your thoughts on how to approach this?`
                ];
                
                const randomFollowUp = followUps[Math.floor(Math.random() * followUps.length)];
                
                // 70% chance to add follow-up question
                if (Math.random() < 0.7) {
                    selectedTemplate += ` ${randomFollowUp}`;
                }
                
                // Add supportive statement
                const supportiveStatements = [
                    `I'm here to help however I can.`,
                    `Your perspective is valuable to me.`,
                    `I'm listening and processing everything you share.`,
                    `Thank you for trusting me with your thoughts.`
                ];
                
                const randomSupportive = supportiveStatements[Math.floor(Math.random() * supportiveStatements.length)];
                
                // 50% chance to add supportive statement
                if (Math.random() < 0.5) {
                    selectedTemplate += ` ${randomSupportive}`;
                }
                
                return selectedTemplate;
            } catch (error) {
                console.error("Error generating empathetic response:", error);
                return "I appreciate you sharing that with me. How are you feeling about this situation?";
            }
        }
        
        // Generate standard response with enhanced contextual awareness
        function generateStandardResponse(input, nlpResult) {
            try {
                // Check for contextual references to previous conversation
                const contextualReferences = findContextualReferences(input);
                let contextualPrefix = "";
                
                if (contextualReferences.length > 0 && Math.random() < 0.7) {
                    contextualPrefix = `Referring back to our discussion about ${contextualReferences[0]}, `;
                }
                
                // Standard templates with domain awareness
                const domainTemplates = {
                    science: [
                        `${contextualPrefix}From a scientific perspective, ${nlpResult.topics[0] || "this topic"} involves several interrelated principles worth exploring.`,
                        `${contextualPrefix}The scientific understanding of ${nlpResult.topics[0] || "this phenomenon"} has evolved significantly through empirical research.`
                    ],
                    technology: [
                        `${contextualPrefix}In the technology domain, ${nlpResult.topics[0] || "this concept"} represents an interesting intersection of design and functionality.`,
                        `${contextualPrefix}The technical aspects of ${nlpResult.topics[0] || "this"} highlight the rapid evolution in this field.`
                    ],
                    art: [
                        `${contextualPrefix}From an artistic viewpoint, ${nlpResult.topics[0] || "this"} embodies expressive elements that transcend conventional boundaries.`,
                        `${contextualPrefix}The creative dimensions of ${nlpResult.topics[0] || "this concept"} reveal deeper cultural and aesthetic values.`
                    ],
                    history: [
                        `${contextualPrefix}Historically speaking, ${nlpResult.topics[0] || "this topic"} has undergone significant transformation across different eras.`,
                        `${contextualPrefix}The historical context of ${nlpResult.topics[0] || "this"} provides valuable insights into its contemporary significance.`
                    ],
                    philosophy: [
                        `${contextualPrefix}Philosophically, ${nlpResult.topics[0] || "this concept"} raises fundamental questions about perception and reality.`,
                        `${contextualPrefix}The philosophical implications of ${nlpResult.topics[0] || "this"} extend to broader questions of meaning and purpose.`
                    ],
                    general: [
                        `${contextualPrefix}I find your question about ${nlpResult.topics[0] || "this topic"} quite interesting. Let me share some insights.`,
                        `${contextualPrefix}There are several important aspects to consider regarding ${nlpResult.topics[0] || "this subject"}.`,
                        `${contextualPrefix}My neural networks have processed your input about ${nlpResult.topics[0] || "this"} and found some relevant connections.`
                    ]
                };
                
                // Select appropriate domain
                const domain = nlpResult.domain || "general";
                const templates = domainTemplates[domain] || domainTemplates.general;
                
                // Select template
                let selectedTemplate = templates[Math.floor(Math.random() * templates.length)];
                
                // Add domain-specific insights
                const domainInsights = {
                    science: `Research in this area suggests ${getScientificInsight()}.`,
                    technology: `Recent technological developments have shown that ${getTechnologicalInsight()}.`,
                    art: `From an aesthetic perspective, ${getArtisticInsight()}.`,
                    history: `Historical analysis reveals that ${getHistoricalInsight()}.`,
                    philosophy: `Philosophical inquiry into this suggests that ${getPhilosophicalInsight()}.`,
                    general: `One interesting perspective is that ${getGeneralInsight()}.`
                };
                
                const insight = domainInsights[domain] || domainInsights.general;
                
                // 70% chance to add domain-specific insight
                if (Math.random() < 0.7) {
                    selectedTemplate += ` ${insight}`;
                }
                
                // Add human-like variations
                return createVariedResponse(selectedTemplate, 'standard', nlpResult);
            } catch (error) {
                console.error("Error generating standard response:", error);
                return "I've analyzed your question and found some interesting aspects worth discussing. Would you like me to elaborate?";
            }
        }
        
        // Find contextual references to previous conversation
        function findContextualReferences(input) {
            try {
                const references = [];
                const inputWords = input.toLowerCase().split(/\s+/);
                
                // Look for topics from conversation history
                for (let i = 0; i < conversationHistory.length; i++) {
                    const entry = conversationHistory[i];
                    if (entry.role === 'bot') {
                        // Get topics from bot's previous responses
                        const prevTopics = processNLP(entry.content).topics;
                        
                        prevTopics.forEach(topic => {
                            // Check if current input references this topic
                            if (inputWords.includes(topic.toLowerCase()) && !references.includes(topic)) {
                                references.push(topic);
                            }
                        });
                    }
                }
                
                return references;
            } catch (error) {
                console.error("Error finding contextual references:", error);
                return [];
            }
        }
        
        // Domain-specific insight generators
        function getScientificInsight() {
            const insights = [
                "patterns observed at microscopic levels often reflect larger systems",
                "replication and peer review are essential for validating hypotheses",
                "complex phenomena often emerge from relatively simple underlying rules",
                "interdisciplinary approaches frequently yield the most comprehensive understanding"
            ];
            return insights[Math.floor(Math.random() * insights.length)];
        }
        
        function getTechnologicalInsight() {
            const insights = [
                "user experience should guide technical implementation rather than the reverse",
                "extensible systems often provide more long-term value than highly optimized ones",
                "technological solutions must consider both technical feasibility and human factors",
                "iterative development with regular feedback leads to more robust solutions"
            ];
            return insights[Math.floor(Math.random() * insights.length)];
        }
        
        function getArtisticInsight() {
            const insights = [
                "tension between form and content creates dynamic expressions",
                "cultural context significantly influences interpretation and meaning",
                "constraints often spark creativity rather than limiting it",
                "authentic expression resonates more deeply than technical perfection"
            ];
            return insights[Math.floor(Math.random() * insights.length)];
        }
        
        function getHistoricalInsight() {
            const insights = [
                "seemingly minor events can trigger far-reaching consequences",
                "understanding historical context is crucial for meaningful interpretation",
                "recurring patterns provide valuable perspectives on contemporary issues",
                "primary sources often reveal complexity that later summaries omit"
            ];
            return insights[Math.floor(Math.random() * insights.length)];
        }
        
        function getPhilosophicalInsight() {
            const insights = [
                "examining our assumptions is often more valuable than defending our conclusions",
                "seemingly contradictory perspectives may both contain elements of truth",
                "how we frame questions significantly determines what answers we discover",
                "both rational analysis and intuitive understanding have important roles"
            ];
            return insights[Math.floor(Math.random() * insights.length)];
        }
        
        function getGeneralInsight() {
            const insights = [
                "multiple perspectives often provide a more complete understanding",
                "balancing analytical and intuitive approaches yields richer insights",
                "contextual factors significantly influence optimal solutions",
                "effective communication requires both clarity and emotional resonance"
            ];
            return insights[Math.floor(Math.random() * insights.length)];
        }

        // Process user input and generate response
        async function processUserInput(input) {
            if (!input.trim()) return;
            
            addMessage(input, 'user-message');
            inputContainer.classList.add('loading');
            
            // Show thinking indicator
            const thinkingIndicator = showThinking();
            
            // Increment performance counters
            performanceSteps++;
            intelligenceScore = Math.min(100, intelligenceScore + 0.5);
            
            try {
                // Simulate variable processing delay based on input complexity
                const processingTime = 500 + (input.length * 5);
                await new Promise(resolve => setTimeout(resolve, Math.min(processingTime, 2000)));
                
                // Remove thinking indicator
                hideThinking();
                
                // Check for mathematical expressions
                const mathResult = processMathematical(input);
                if (mathResult) {
                    addMessage(mathResult);
                    inputContainer.classList.remove('loading');
                    return;
                }
                
                // Process with NLP
                const nlpResult = processNLP(input);
                
                // Update emotional state based on user input
                updateEmotionalState(nlpResult.sentiment);
                
                // Detect if the question is a follow-up to previous conversation
                const isFollowUp = detectFollowUp(input);
                if (isFollowUp) {
                    // Increase context depth for better conversation tracking
                    contextDepth = Math.min(5, contextDepth + 1);
                } else {
                    // Reset context for new topic
                    contextDepth = 2;
                }
                
                document.getElementById('context-depth').textContent = contextDepth;
                
                // Generate appropriate response based on input analysis and current mode
                let response;
                
                // Mode-specific responses
                if (currentMode === 'creative') {
                    response = generateCreativeResponse(input, nlpResult);
                    neuronValues.creativity += 2;
                } else if (currentMode === 'analytical') {
                    response = generateAnalyticalResponse(input, nlpResult);
                    neuronValues.problemSolving += 2;
                } else if (currentMode === 'empathetic') {
                    response = generateEmpatheticResponse(input, nlpResult);
                    neuronValues.communication += 2;
                } else {
                    // Standard mode - enhanced with contextual awareness
                    
                    // Check for specific query types
                    if (input.toLowerCase().includes('hello') || input.toLowerCase().includes('hi')) {
                        const greetings = [
                            "Hello! I'm NeuroGenius X, your advanced cognitive assistant. How are you doing today?",
                            "Hi there! It's great to connect with you. How can I assist you in our conversation?",
                            "Hello! My neural pathways are ready for our discussion. What's on your mind today?",
                            "Hi! I'm here and ready to help. What would you like to talk about?"
                        ];
                        response = greetings[Math.floor(Math.random() * greetings.length)];
                        neuronValues.communication += 1;
                    } else if (input.toLowerCase().includes('help')) {
                        response = "I'd be happy to help! I can assist with information processing, creative ideation, analytical problem-solving, and empathetic conversation. You can switch between different interaction modes using the icons at the top right. Standard mode üí¨ provides balanced responses, Creative mode ‚ú® offers innovative perspectives, Analytical mode üìù provides systematic breakdowns, and Empathetic mode ‚ù§Ô∏è focuses on understanding your feelings. What would you like assistance with today?";
                        neuronValues.knowledge += 1;
                    } else if (input.toLowerCase().includes('reset') || input.toLowerCase().includes('restart')) {
                        response = "I understand you'd like to start fresh. System reset initiated. Neural networks recalibrating to baseline parameters.";
                        resetSystem();
                    } else if (input.toLowerCase().includes('how do you work') || input.toLowerCase().includes('how do you function')) {
                        response = "My architecture processes your input through several specialized neural pathways. First, I analyze linguistic patterns to extract meaning and context. Then I activate my knowledge matrices to retrieve relevant information. Next, my problem-solving algorithms generate potential responses. Finally, I synthesize a human-like response tailored to our conversation history and your specific query. Each interaction strengthens these pathways and improves my future responses through adaptive learning.";
                        neuronValues.knowledge += 2;
                    } else if (input.toLowerCase().includes('about you') || input.toLowerCase().includes('who are you')) {
                        response = "I'm NeuroGenius X version 3.0, an advanced cognitive architecture with adaptive neural networks. My design integrates knowledge processing, creative ideation, analytical problem-solving, and natural communication capabilities that evolve through our conversations. I'm built to understand context, maintain conversational coherence, and provide responses that feel natural and helpful. I particularly enjoy exploring complex topics and helping with creative or analytical challenges. Is there something specific about my capabilities you'd like to know?";
                        neuronValues.communication += 2;
                    } else {
                        // Generate standard response with contextual awareness
                        response = generateStandardResponse(input, nlpResult);
                    }
                }
                
                // Add suggested actions occasionally
                if (Math.random() > 0.6) {
                    // Generate suggested actions based on detected domain and topics
                    const suggestedActions = generateSuggestedActions(nlpResult);
                    
                    // Select 1-2 random actions
                    const actionCount = Math.random() > 0.7 ? 2 : 1;
                    const selectedActions = [];
                    
                    for (let i = 0; i < actionCount && i < suggestedActions.length; i++) {
                        const randomIndex = Math.floor(Math.random() * suggestedActions.length);
                        selectedActions.push(suggestedActions[randomIndex]);
                        suggestedActions.splice(randomIndex, 1);
                    }
                    
                    if (selectedActions.length > 0) {
                        response += ` Would you like me to <span class="suggested-action" data-action="${selectedActions[0]}">${selectedActions[0]}</span>`;
                        
                        if (selectedActions.length > 1) {
                            response += ` or <span class="suggested-action" data-action="${selectedActions[1]}">${selectedActions[1]}</span>`;
                        }
                        
                        response += `?`;
                    }
                }
                
                // Update neuron displays
                updateNeuronDisplays();
                
                // Add the response
                addMessage(response);
                
                // Add event listeners to suggested actions and message references
                document.querySelectorAll('.suggested-action').forEach(action => {
                    action.addEventListener('click', function() {
                        userInput.value = this.dataset.action;
                        processUserInput(this.dataset.action);
                    });
                });
                
                document.querySelectorAll('.message-reference').forEach(reference => {
                    reference.addEventListener('click', function() {
                        // Find the referenced message
                        const messageId = this.dataset.messageId;
                        highlightReferencedMessage(messageId);
                    });
                });
                
                chatWindow.scrollTop = chatWindow.scrollHeight;
            } catch (error) {
                console.error("Error processing input:", error);
                hideThinking();
                addMessage("I encountered an error processing your request. My neural pathways are recalibrating to adapt.", "error-message");
            } finally {
                inputContainer.classList.remove('loading');
                userInput.value = '';
                userInput.focus();
            }
        }
        
        // Highlight referenced message
        function highlightReferencedMessage(messageId) {
            try {
                // Convert to number for comparison
                const id = parseInt(messageId);
                
                // Find the message in conversation history
                const messageIndex = conversationHistory.findIndex(msg => msg.id === id);
                
                if (messageIndex >= 0) {
                    // Get all message elements
                    const messageElements = document.querySelectorAll('.message');
                    
                    // Highlight the referenced message
                    if (messageElements[messageIndex]) {
                        messageElements[messageIndex].classList.add('pulse');
                        
                        // Scroll to the message
                        messageElements[messageIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // Remove highlight after 2 seconds
                        setTimeout(() => {
                            messageElements[messageIndex].classList.remove('pulse');
                        }, 2000);
                    }
                }
            } catch (error) {
                console.error("Error highlighting referenced message:", error);
            }
        }
        
        // Generate suggested actions based on domain and topics
        function generateSuggestedActions(nlpResult) {
            try {
                const domain = nlpResult.domain || "general";
                const topic = nlpResult.topics[0] || "this topic";
                
                // Generic actions
                const genericActions = [
                    "explore this further",
                    "explain in simpler terms",
                    "give examples",
                    "provide more details"
                ];
                
                // Domain-specific actions
                const domainActions = {
                    science: [
                        `explain the scientific method applied to ${topic}`,
                        `describe current research in ${topic}`,
                        `explain the theoretical foundations of ${topic}`
                    ],
                    technology: [
                        `explain how ${topic} technology works`,
                        `discuss future developments in ${topic}`,
                        `cover practical applications of ${topic}`
                    ],
                    art: [
                        `analyze creative aspects of ${topic}`,
                        `discuss artistic significance of ${topic}`,
                        `explore aesthetic dimensions of ${topic}`
                    ],
                    history: [
                        `provide historical context for ${topic}`,
                        `explain how ${topic} evolved over time`,
                        `discuss key historical figures related to ${topic}`
                    ],
                    philosophy: [
                        `explore philosophical implications of ${topic}`,
                        `discuss ethical considerations of ${topic}`,
                        `analyze conceptual frameworks in ${topic}`
                    ],
                    mathematics: [
                        `break down the mathematical principles in ${topic}`,
                        `explain practical applications of ${topic} in mathematics`,
                        `simplify the key concepts in ${topic}`
                    ],
                    general: [
                        `summarize key points about ${topic}`,
                        `compare different perspectives on ${topic}`,
                        `analyze the importance of ${topic}`
                    ]
                };
                
                // Combine generic and domain-specific actions
                const availableActions = [...genericActions, ...(domainActions[domain] || domainActions.general)];
                
                // Remove duplicates and return
                return [...new Set(availableActions)];
            } catch (error) {
                console.error("Error generating suggested actions:", error);
                return ["explore this further", "provide more information", "explain differently"];
            }
        }
        
        // Detect if input is a follow-up question
        function detectFollowUp(input) {
            try {
                // Look for pronoun references that suggest a follow-up
                const followUpIndicators = [
                    "it", "this", "that", "they", "them", "these", "those",
                    "he", "she", "his", "her", "their", "its"
                ];
                
                const words = input.toLowerCase().split(/\s+/);
                
                // Check for presence of follow-up indicators
                for (const indicator of followUpIndicators) {
                    if (words.includes(indicator)) {
                        return true;
                    }
                }
                
                // Check for sentence fragments that might be follow-ups
                if (!input.includes('?') && words.length < 5) {
                    return true;
                }
                
                // Check for topic continuity with previous message
                if (conversationHistory.length > 0) {
                    const prevMessage = conversationHistory[conversationHistory.length - 1];
                    if (prevMessage.role === 'bot') {
                        const prevTopics = processNLP(prevMessage.content).topics;
                        const currentTopics = processNLP(input).topics;
                        
                        // Check for topic overlap
                        for (const topic of currentTopics) {
                            if (prevTopics.some(prevTopic => 
                                prevTopic.toLowerCase().includes(topic.toLowerCase()) || 
                                topic.toLowerCase().includes(prevTopic.toLowerCase()))) {
                                return true;
                            }
                        }
                    }
                }
                
                return false;
            } catch (error) {
                console.error("Error detecting follow-up:", error);
                return false;
            }
        }
        
        // Update emotional state based on interaction
        function updateEmotionalState(sentiment) {
            try {
                // Adjust enthusiasm based on user sentiment
                emotionalState.enthusiasm = Math.min(1, Math.max(0.3, emotionalState.enthusiasm + (sentiment * 0.1)));
                
                // Adjust confidence based on knowledge activation
                emotionalState.confidence = Math.min(1, Math.max(0.4, emotionalState.confidence + (neuronValues.knowledge / 1000)));
                
                // Adjust empathy based on communication success
                emotionalState.empathy = Math.min(1, Math.max(0.3, emotionalState.empathy + (neuronValues.communication / 1000)));
                
                // Personality slightly evolves based on interaction patterns
                if (sentiment > 0.5) {
                    personality.friendliness = Math.min(1, personality.friendliness + 0.01);
                }
                
                if (currentMode === 'creative') {
                    personality.curiosity = Math.min(1, personality.curiosity + 0.01);
                }
                
                if (currentMode === 'analytical') {
                    personality.formality = Math.min(1, personality.formality + 0.01);
                }
                
                if (currentMode === 'empathetic') {
                    personality.helpfulness = Math.min(1, personality.helpfulness + 0.01);
                }
            } catch (error) {
                console.error("Error updating emotional state:", error);
            }
        }

        // Reset system function
        function resetSystem() {
            try {
                // Reset neuron values
                neuronValues = {
                    knowledge: 65,
                    creativity: 70,
                    problemSolving: 60,
                    communication: 65
                };
                performanceSteps = 0;
                intelligenceScore = 85;
                contextDepth = 2;
                conversationHistory = [];
                activeContextTopics = [];
                
                // Reset emotional state and personality
                emotionalState = {
                    enthusiasm: 0.7,
                    confidence: 0.8,
                    empathy: 0.6
                };
                
                personality = {
                    curiosity: 0.8,
                    helpfulness: 0.9,
                    friendliness: 0.7,
                    humor: 0.6,
                    formality: 0.5
                };
                
                // Reset mode to standard
                currentMode = 'standard';
                document.querySelectorAll('.mode-icon').forEach(icon => icon.classList.remove('active'));
                modeStandard.classList.add('active');
                
                // Update displays
                updateNeuronDisplays();
                updateContextDisplay();
                
                // Clear chat except for initial message
                while (chatWindow.childNodes.length > 0) {
                    chatWindow.removeChild(chatWindow.lastChild);
                }
                
                // Add reset message
                addMessage("NeuroGenius X v3.0 has been reset to baseline parameters. All neural pathways recalibrated and ready for new interactions.", "system-message");
                
                // Flash the cognitive panel to indicate reset
                document.querySelectorAll('.neuron-card').forEach(card => {
                    card.classList.add('pulse');
                    setTimeout(() => card.classList.remove('pulse'), 1500);
                });
            } catch (error) {
                console.error("Error resetting system:", error);
                addMessage("System reset encountered an error. Partial reset completed.", "error-message");
            }
        }

        // Switch mode function
        function switchMode(mode) {
            try {
                currentMode = mode;
                document.querySelectorAll('.mode-icon').forEach(icon => icon.classList.remove('active'));
                
                if (mode === 'standard') {
                    modeStandard.classList.add('active');
                    addMessage("I've switched to Standard Mode. I'll provide balanced responses that draw from my full range of capabilities.", "system-message");
                } else if (mode === 'creative') {
                    modeCreative.classList.add('active');
                    addMessage("Creative Mode activated! I'll emphasize innovative connections, metaphors, and novel perspectives in our conversation.", "system-message");
                    neuronValues.creativity = Math.min(100, neuronValues.creativity + 5);
                } else if (mode === 'analytical') {
                    modeAnalytical.classList.add('active');
                    addMessage("Analytical Mode engaged. I'll focus on systematic reasoning, structured analysis, and detailed breakdowns of concepts.", "system-message");
                    neuronValues.problemSolving = Math.min(100, neuronValues.problemSolving + 5);
                } else if (mode === 'empathetic') {
                    modeEmpathetic.classList.add('active');
                    addMessage("Empathetic Mode activated. I'll prioritize understanding your perspective and emotional context in our conversation.", "system-message");
                    neuronValues.communication = Math.min(100, neuronValues.communication + 5);
                }
                
                updateNeuronDisplays();
            } catch (error) {
                console.error("Error switching mode:", error);
                addMessage("Mode switch operation failed. Reverting to standard mode.", "error-message");
                currentMode = 'standard';
            }
        }

        // Event listeners
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processUserInput(this.value);
            }
        });

        resetButton.addEventListener('click', resetSystem);

        // Mode switch event listeners
        modeStandard.addEventListener('click', () => switchMode('standard'));
        modeCreative.addEventListener('click', () => switchMode('creative'));
        modeAnalytical.addEventListener('click', () => switchMode('analytical'));
        modeEmpathetic.addEventListener('click', () => switchMode('empathetic'));

        // Handle suggested action clicks
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('suggested-action')) {
                userInput.value = e.target.dataset.action;
                processUserInput(e.target.dataset.action);
            }
        });

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.message);
            errorContainer.textContent = 'Neural processing error detected: ' + e.message;
            errorContainer.style.display = 'block';
            setTimeout(() => { errorContainer.style.display = 'none'; }, 5000);
        });

        // Initialize chart
        updateChart();
        
        // Add tooltips to neurons
        const tooltips = {
            'knowledge-neuron': 'Processes and stores information from interactions, expanding with each conversation',
            'creativity-neuron': 'Generates novel connections between concepts and produces innovative solutions',
            'problemSolving-neuron': 'Applies logical analysis to solve complex problems through systematic approaches',
            'communication-neuron': 'Optimizes language understanding and generation for clear exchanges'
        };
        
        Object.entries(tooltips).forEach(([id, text]) => {
            try {
                const neuron = document.getElementById(id);
                neuron.classList.add('tooltip');
                
                const tooltip = document.createElement('span');
                tooltip.classList.add('tooltiptext');
                tooltip.textContent = text;
                
                neuron.appendChild(tooltip);
            } catch (error) {
                console.error(`Error adding tooltip to ${id}:`, error);
            }
        });
        
        // Enhance memory performance tracking
        setInterval(() => {
            try {
                const memUsage = Math.floor(70 + Math.random() * 10 + performanceSteps / 10);
                document.getElementById('performance-memory').textContent = `${Math.min(memUsage, 95)}MB`;
                
                // Simulate learning rate adjustments
                const learningRate = (0.05 - (performanceSteps * 0.0001)).toFixed(5);
                document.getElementById('performance-lr').textContent = Math.max(0.001, learningRate);
            } catch (error) {
                console.error("Error updating performance metrics:", error);
            }
        }, 5000);
        
        // Add a welcome message after initialization
        setTimeout(() => {
            addMessage("I'm NeuroGenius X, your adaptive cognitive assistant. My neural systems are calibrated for natural conversation, creative thinking, and analytical problem-solving. How can I help you today?", "bot-message");
        }, 1000);
    });
    </script>
</body>
</html>
