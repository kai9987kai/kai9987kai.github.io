<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Subscription Reminder — Advanced</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg: #0b1115;
      --panel: #0f1720;
      --panel-2: #131c26;
      --text: #e8f0f7;
      --muted: #a2b3c2;
      --brand: #43c76f;
      --brand-2: #2fa25a;
      --warn: #ffbf47;
      --danger: #ff5d5d;
      --ok: #6dd594;
      --shadow: 0 6px 24px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.25);
    }
    [data-theme="light"]{
      --bg: #f4f7fb;
      --panel: #ffffff;
      --panel-2: #f3f6fa;
      --text: #0f1a22;
      --muted: #4e6476;
      --brand: #2ea95f;
      --brand-2: #23864b;
      --warn: #a86d00;
      --danger: #c53b3b;
      --ok: #218a4a;
      --shadow: 0 6px 24px rgba(14,36,52,0.12), 0 2px 8px rgba(14,36,52,0.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; padding:0;
      background: linear-gradient(180deg, var(--bg), #0b0f13 70%);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    header{
      position:sticky; top:0; z-index:10;
      background: linear-gradient(180deg, var(--panel), rgba(0,0,0,0.0));
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      box-shadow: var(--shadow);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:16px;}
    h1{
      margin:0;
      display:flex; align-items:center; gap:12px;
      font-weight:800; letter-spacing:0.2px; font-size: clamp(20px, 2.6vw, 28px);
    }
    .logo{
      width:28px; height:28px; display:inline-grid; place-items:center;
      border-radius:8px; background: radial-gradient(90% 90% at 30% 30%, #6af59a, #36c671 50%, #167c42 100%);
      box-shadow: inset 0 2px 8px rgba(255,255,255,0.25), 0 4px 10px rgba(0,0,0,0.35);
    }
    .muted{color: var(--muted)}
    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; margin-top:8px;
    }
    .toolbar .left, .toolbar .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      background: var(--panel-2); padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,0.07);
    }
    .btn, button, input[type="submit"]{
      background: var(--brand); color:#062612; border:none; padding:10px 14px; border-radius:10px;
      cursor:pointer; font-weight:700; box-shadow: var(--shadow); transition:transform .05s ease, filter .15s ease, background .2s ease;
    }
    .btn:active, button:active{ transform: translateY(1px) scale(0.99); }
    .btn.secondary{ background: #1e2a36; color: var(--text); }
    .btn.warn{ background: var(--warn); color:#1e1200;}
    .btn.danger{ background: var(--danger); color:#fff;}
    .btn.ghost{ background: transparent; border:1px solid rgba(255,255,255,0.1); color: var(--text)}
    .btn.small{ padding:6px 10px; font-size:13px; border-radius:8px; }
    .btn.tiny{ padding:4px 8px; font-size:12px; border-radius:7px; }

    main{max-width:1100px; margin:16px auto; padding:0 16px 24px;}
    .grid{
      display:grid; gap:16px; grid-template-columns:1.3fr 1fr;
    }
    @media (max-width: 960px){ .grid{ grid-template-columns:1fr; } }

    .panel{
      background: linear-gradient(180deg, var(--panel), #0c131b);
      border:1px solid rgba(255,255,255,0.07);
      box-shadow: var(--shadow);
      border-radius:18px; padding:16px;
    }
    .panel h2{margin:0 0 12px 0; font-size: clamp(16px, 2.1vw, 20px);}

    form .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    form .row-3{ grid-template-columns: 1fr 1fr 1fr; }
    form .row-4{ grid-template-columns: 1.2fr 1fr 1fr 1fr; }
    @media (max-width:680px){ form .row, form .row-3, form .row-4 { grid-template-columns:1fr; } }

    label{ font-size:13px; color: var(--muted); display:block; margin:6px 2px; }
    input, select, textarea{
      width:100%; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12);
      background: var(--panel-2); color: var(--text); outline:none;
    }
    input:focus, select:focus, textarea:focus{ border-color: var(--brand); box-shadow: 0 0 0 3px rgba(67,199,111,0.2); }
    textarea{ min-height:72px; resize:vertical; }

    .reminders{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:4px;
    }
    .reminders label{ display:flex; align-items:center; gap:6px; background: var(--panel-2); padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.08); }
    .switch{
      display:inline-flex; align-items:center; gap:10px; cursor:pointer; user-select:none;
    }
    .switch input{ display:none; }
    .switch .track{ width:48px; height:26px; border-radius:999px; background:#233042; position:relative; border:1px solid rgba(255,255,255,0.1); }
    .switch .thumb{ position:absolute; top:1px; left:1px; width:22px; height:22px; background:#fff; border-radius:50%; transition:left .2s ease; }
    .switch input:checked + .track .thumb{ left:25px; }

    .list{
      display:grid; gap:10px; margin-top:8px;
    }
    .item{
      display:grid; gap:10px; grid-template-columns: 1fr auto;
      padding:12px; border-radius:14px; background: linear-gradient(180deg, var(--panel-2), #0b1219);
      border:1px solid rgba(255,255,255,0.07);
    }
    .when{ font-size:13px; color: var(--muted); }
    .name{ font-weight:800; letter-spacing:0.2px; font-size:16px; }
    .note{ color: var(--muted); font-size:13px; margin-top:4px; }
    .meta{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .badge{ font-size:12px; padding:4px 8px; background:#1b2734; border-radius:999px; border:1px solid rgba(255,255,255,0.08); }
    .badge.amount{ background:#132a1b; border-color: rgba(67,199,111,0.25); }
    .badge.overdue{ background:#2e1010; border-color: rgba(255,93,93,0.35); color: #ffbdbd; }
    .badge.soon{ background:#2c260e; border-color: rgba(255,191,71,0.35); color: #ffd78a; }
    .badge.ok{ background:#102515; border-color: rgba(90,220,140,0.3); color: #a7efc2; }
    .actions{ display:flex; gap:6px; align-items:center; }
    .actions .btn{ box-shadow:none; }

    .totals{
      display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:8px;
    }
    @media (max-width:720px){ .totals{ grid-template-columns:1fr; } }
    .tile{
      background: linear-gradient(180deg, var(--panel-2), #0b1219);
      border:1px solid rgba(255,255,255,0.07);
      padding:14px; border-radius:14px;
    }
    .tile .label{ font-size:12px; color: var(--muted); }
    .tile .big{ font-size:20px; font-weight:800; margin-top:6px; }
    .progress{
      margin-top:10px; height:10px; background:#17202b; border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,0.08);
    }
    .progress > i{ display:block; height:100%; width:0%; background: linear-gradient(90deg, var(--brand), #7bf0a9); transition: width .4s ease; }

    .footer{
      margin-top:18px; font-size:12px; color:var(--muted);
    }

    .hidden{display:none !important}
  </style>
</head>
<body data-theme="dark">
  <header>
    <div class="wrap">
      <h1>
        <span class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" role="img" aria-label="logo"><path fill="#0b3e24" d="M12 2a10 10 0 1 0 10 10A10.012 10.012 0 0 0 12 2Z"/><path fill="#e8fff2" d="M11 6h2v12h-2z"/><path fill="#e8fff2" d="M6 11h12v2H6z"/></svg>
        </span>
        Subscription Reminder
        <span class="muted" style="font-weight:500;">· smarter alerts, better control</span>
      </h1>
      <div class="toolbar">
        <div class="left">
          <span class="chip">
            <strong>Theme</strong>
            <label class="switch">
              <input id="themeSwitch" type="checkbox" />
              <span class="track"><span class="thumb"></span></span>
            </label>
          </span>
          <span class="chip">
            <strong>Notifications</strong>
            <button id="btnEnableNotif" class="btn small">Enable</button>
          </span>
          <span class="chip">
            <strong>Quick</strong>
            <button id="btnSample" class="btn small secondary" title="Add sample items for demo">Add Demo</button>
            <button id="btnTest" class="btn small secondary" title="Test notification">Test Ping</button>
          </span>
        </div>
        <div class="right">
          <input id="search" type="search" placeholder="Search by name, tag…" aria-label="Search" />
          <select id="filter">
            <option value="all">All</option>
            <option value="upcoming">Upcoming</option>
            <option value="overdue">Overdue</option>
            <option value="completed">Completed</option>
          </select>
          <button id="btnExport" class="btn ghost">Export JSON</button>
          <button id="btnImport" class="btn ghost">Import JSON</button>
          <input id="fileImport" type="file" accept="application/json" class="hidden" />
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- Left: Form + List -->
      <section class="panel">
        <h2>Add / Edit Subscription</h2>
        <form id="form">
          <input type="hidden" id="id" />
          <div class="row-4">
            <div>
              <label for="name">Name</label>
              <input id="name" placeholder="e.g., Netflix, Phone, Rent" required />
            </div>
            <div>
              <label for="due">Due (date & time)</label>
              <input id="due" type="datetime-local" required />
            </div>
            <div>
              <label for="amount">Amount</label>
              <input id="amount" type="number" step="0.01" min="0" placeholder="0.00" />
            </div>
            <div>
              <label for="currency">Currency</label>
              <select id="currency" aria-label="Currency">
                <option value="GBP">GBP £</option>
                <option value="USD">USD $</option>
                <option value="EUR">EUR €</option>
              </select>
            </div>
          </div>

          <div class="row-3">
            <div>
              <label>Reminders</label>
              <div class="reminders">
                <label><input type="checkbox" class="rem" value="604800000" />7 days</label>
                <label><input type="checkbox" class="rem" value="86400000" />1 day</label>
                <label><input type="checkbox" class="rem" value="21600000" />6 hours</label>
                <label><input type="checkbox" class="rem" value="3600000" />1 hour</label>
                <label><input type="checkbox" class="rem" value="900000" />15 min</label>
              </div>
            </div>
            <div>
              <label for="recurrence">Recurrence</label>
              <select id="recurrence">
                <option value="none">None</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly (same day)</option>
                <option value="yearly">Yearly (same date)</option>
                <option value="custom">Custom (days)</option>
              </select>
              <input id="customInterval" type="number" class="hidden" min="1" step="1" placeholder="Interval days (e.g. 30)"/>
            </div>
            <div>
              <label for="tags">Tags (comma)</label>
              <input id="tags" placeholder="e.g., streaming, utility" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="notes">Notes</label>
              <textarea id="notes" placeholder="Optional: account email, plan, etc."></textarea>
            </div>
            <div>
              <label for="completed">Status</label>
              <select id="completed">
                <option value="false">Active</option>
                <option value="true">Completed/Paid</option>
              </select>
              <div style="height:8px"></div>
              <button class="btn" type="submit" id="submitBtn">Add Subscription</button>
              <button class="btn ghost" type="button" id="resetBtn">Reset</button>
            </div>
          </div>
        </form>

        <div class="totals">
          <div class="tile">
            <div class="label">Due in next 30 days</div>
            <div class="big" id="sum30">£0.00</div>
            <div class="progress"><i id="bar30" style="width:0%"></i></div>
          </div>
          <div class="tile">
            <div class="label">Overdue count</div>
            <div class="big" id="overdueCount">0</div>
            <div class="progress"><i id="barOverdue" style="width:0%"></i></div>
          </div>
          <div class="tile">
            <div class="label">Active subscriptions</div>
            <div class="big" id="activeCount">0</div>
            <div class="progress"><i id="barActive" style="width:0%"></i></div>
          </div>
        </div>

        <div class="list" id="list" aria-live="polite"></div>

        <div class="footer">
          Your data lives only in your browser (localStorage). Reminders fire while this tab is open.
          Add the event to your calendar for system-level alerts. Works offline; enable notifications above for rich alerts.
        </div>
      </section>

      <!-- Right: Tips / Help -->
      <aside class="panel">
        <h2>Tips</h2>
        <ul style="margin-top:4px; line-height:1.6">
          <li>Click a card’s <em>Edit</em> to update anything; <em>Snooze</em> gives you breathing room (10 mins).</li>
          <li>Use <strong>Multiple reminders</strong> to get a “drumroll” before renewal day.</li>
          <li><strong>Recurring</strong>: weekly/monthly/yearly/custom (N days). The due date auto-advances when marked paid.</li>
          <li><strong>Export JSON</strong> for backup; you can also import from a previous file.</li>
          <li><strong>ICS</strong> adds a calendar entry; <strong>GCal</strong> link opens Google Calendar with the event prefilled.</li>
          <li>Totals panel updates live with your upcoming cost and counts.</li>
          <li>Dark/Light theme toggle at the top. Preferences persist.</li>
        </ul>
        <div class="tile" style="margin-top:10px;">
          <div class="label">What counts as “soon”?</div>
          <div class="big" style="font-size:14px; font-weight:600;">Within 72 hours</div>
        </div>
      </aside>
    </div>
  </main>

  <script>
  // ---------- Utilities ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const now = () => new Date();
  const clamp = (x, a, b) => Math.min(b, Math.max(a, x));
  const currencySymbol = cur => ({GBP:"£", USD:"$", EUR:"€"}[cur] || "");

  // Local storage keys
  const KEY = "submgr.v2.items";
  const KEY_PREF = "submgr.v2.prefs";

  // BroadcastChannel for multi-tab sync
  const bc = ("BroadcastChannel" in self) ? new BroadcastChannel("submgr") : null;
  if (bc) bc.onmessage = (e) => { if (e?.data === "refresh") { load(); render(); } };

  // Preferences
  const prefs = loadPrefs();
  function loadPrefs(){
    try{ return JSON.parse(localStorage.getItem(KEY_PREF)) || { theme: "dark" }; }
    catch{ return { theme: "dark" }; }
  }
  function savePrefs(){ localStorage.setItem(KEY_PREF, JSON.stringify(prefs)); }

  // Theme
  (function initTheme(){
    document.body.setAttribute("data-theme", prefs.theme || "dark");
    $("#themeSwitch").checked = (prefs.theme === "light");
    $("#themeSwitch").addEventListener("change", () => {
      prefs.theme = ($("#themeSwitch").checked ? "light":"dark");
      document.body.setAttribute("data-theme", prefs.theme);
      savePrefs();
    });
  })();

  // ---------- Service Worker (blob) for offline + notification display ----------
  async function registerSW(){
    if (!('serviceWorker' in navigator)) return null;
    const code = `
      self.addEventListener('install', e => { self.skipWaiting(); });
      self.addEventListener('activate', e => { e.waitUntil(self.clients.claim()); });

      self.addEventListener('message', e => {
        const data = e.data || {};
        if (data.type === 'notify' && self.registration?.showNotification) {
          const title = data.title || 'Reminder';
          const options = Object.assign({
            body: data.body || '',
            icon: data.icon || undefined,
            badge: data.badge || undefined,
            tag: data.tag || 'subscription-reminder',
            timestamp: Date.now(),
            vibrate: [80, 40, 80],
            renotify: true,
          }, data.options || {});
          self.registration.showNotification(title, options);
        }
      });

      self.addEventListener('notificationclick', event => {
        event.notification.close();
        event.waitUntil((async () => {
          const all = await self.clients.matchAll({ type: 'window', includeUncontrolled: true });
          if (all && all.length) { all[0].focus(); return; }
          // Fallback to opening root
          await self.clients.openWindow('./');
        })());
      });
    `;
    const blob = new Blob([code], {type: "text/javascript"});
    const url = URL.createObjectURL(blob);
    try{
      const reg = await navigator.serviceWorker.register(url, { scope: './' });
      return reg;
    }catch(err){
      console.warn("SW registration failed", err);
      return null;
    }
  }
  let swReg = null;
  registerSW().then(r => { swReg = r; });

  // ---------- Notification Helpers ----------
  async function ensureNotifPermission(){
    if (!("Notification" in window)) { alert("Notifications not supported in this browser."); return false; }
    let p = Notification.permission;
    if (p === "granted") return true;
    if (p === "denied") return false;
    // Request on user action
    try{
      const res = await Notification.requestPermission();
      return res === "granted";
    }catch{
      return false;
    }
  }

  async function notify(title, body, tag){
    // Prefer service worker notification; fallback to window Notification
    if (swReg && swReg.active && swReg.showNotification){
      try{
        await swReg.showNotification(title, {
          body, tag: tag || "subscription-reminder", vibrate:[60,30,60]
        });
        return;
      }catch{}
    }
    if (swReg && swReg.active){
      swReg.active.postMessage({ type:"notify", title, body, tag });
      return;
    }
    if ("Notification" in window && Notification.permission === "granted"){
      try{ new Notification(title, { body, tag }); }catch{}
    }
  }

  // Tiny beep using Web Audio for on-page alerts
  function beep(){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.value = 880;
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.25);
      o.start(); o.stop(ctx.currentTime + 0.26);
    }catch{}
  }

  $("#btnEnableNotif").addEventListener("click", async () => {
    const ok = await ensureNotifPermission();
    alert(ok ? "Notifications enabled." : "Notifications not enabled.");
  });
  $("#btnTest").addEventListener("click", async () => {
    if (await ensureNotifPermission()){
      await notify("Subscription Reminder (test)", "This is a test notification.");
      beep();
    }
  });

  // ---------- Data Model ----------
  /**
   * Subscription object:
   * {
   *   id: string, name: string,
   *   dueISO: string (ISO),
   *   amount: number, currency: "GBP"|"USD"|"EUR",
   *   notes: string,
   *   tags: string[],
   *   recurrence: { type: 'none'|'weekly'|'monthly'|'yearly'|'custom', intervalDays?: number }
   *   remindOffsets: number[], // ms before due
   *   createdAt: string ISO,
   *   lastNotified: { [offsetMs]: true }, // which reminder offsets already fired for current due
   *   completed: boolean
   * }
   */
  let items = [];

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      items = raw ? JSON.parse(raw) : [];
      // migration guard
      items.forEach(it => { if (!it.lastNotified) it.lastNotified = {}; });
    }catch{ items = []; }
  }
  function save(){
    localStorage.setItem(KEY, JSON.stringify(items));
    if (bc) bc.postMessage("refresh");
  }
  load();

  // ---------- Helpers ----------
  function parseDateLocalToDate(val){
    // For <input type="datetime-local"> value "YYYY-MM-DDTHH:mm"
    // interpret as local time
    if (!val) return null;
    const [d,t] = val.split("T");
    if (!t) return new Date(val);
    const [Y,M,D] = d.split("-").map(Number);
    const [h,m] = t.split(":").map(Number);
    return new Date(Y, (M-1), D, h||0, m||0, 0, 0);
  }
  function formatDate(dt){
    try{
      return new Intl.DateTimeFormat(undefined, { dateStyle:"medium", timeStyle:"short" }).format(dt);
    }catch{
      return dt.toLocaleString();
    }
  }
  function isoLocal(dt){
    // produce "YYYY-MM-DDTHH:mm" for input controls
    const pad = n => String(n).padStart(2,"0");
    const Y = dt.getFullYear();
    const M = pad(dt.getMonth()+1);
    const D = pad(dt.getDate());
    const h = pad(dt.getHours());
    const m = pad(dt.getMinutes());
    return `${Y}-${M}-${D}T${h}:${m}`;
  }
  function daysBetween(a,b){ return (b - a) / 86400000; }

  function nextOccurrence(it){
    const due = new Date(it.dueISO);
    const t = it.recurrence?.type || "none";
    if (t === "none") return null;
    const clone = new Date(due.getTime());
    if (t === "weekly"){ clone.setDate(clone.getDate() + 7); }
    else if (t === "monthly"){ 
      const d = clone.getDate();
      clone.setMonth(clone.getMonth() + 1);
      // Keep same day where possible; JS rolls overflow automatically
      if (clone.getDate() !== d) {
        // e.g., from Jan 31 -> Mar 2; adjust: move to last day of new month
        clone.setDate(0);
      }
    }
    else if (t === "yearly"){ clone.setFullYear(clone.getFullYear() + 1); }
    else if (t === "custom"){
      const n = Number(it.recurrence.intervalDays || 0) || 0;
      if (n <= 0) return null;
      clone.setDate(clone.getDate() + n);
    }
    return clone;
  }

  function advanceIfCompleted(it){
    if (!it.completed) return;
    const next = nextOccurrence(it);
    if (next){
      it.dueISO = next.toISOString();
      it.completed = false;
      it.lastNotified = {};
    }
  }

  // ---------- Rendering ----------
  const listEl = $("#list");
  function render(){
    // Filter + search
    const q = ($("#search").value || "").trim().toLowerCase();
    const filt = $("#filter").value;

    const nowDt = now();
    const soonHrs = 72;

    const filtered = items.filter(it => {
      // Search text
      const txt = (it.name + " " + (it.tags||[]).join(",") + " " + (it.notes||"")).toLowerCase();
      if (q && !txt.includes(q)) return false;
      // Filter bucket
      const due = new Date(it.dueISO);
      const isOverdue = !it.completed && (due < nowDt);
      const isCompleted = !!it.completed;
      const isUpcoming = !isCompleted && !isOverdue;
      if (filt === "overdue" && !isOverdue) return false;
      if (filt === "completed" && !isCompleted) return false;
      if (filt === "upcoming" && !isUpcoming) return false;
      return true;
    }).sort((a,b) => new Date(a.dueISO) - new Date(b.dueISO));

    listEl.innerHTML = "";
    for (const it of filtered){
      const due = new Date(it.dueISO);
      const diffMs = due - nowDt;
      const diffDays = diffMs / 86400000;
      const isOverdue = !it.completed && diffMs < 0;
      const isSoon = !it.completed && diffDays <= (72/24) && diffDays >= 0;
      const sym = currencySymbol(it.currency || "GBP");
      const tags = (it.tags || []).filter(Boolean);

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div>
          <div class="name">${escapeHtml(it.name)}</div>
          <div class="when">${it.completed ? "Completed on next cycle pending" : (isOverdue ? "Overdue": "Due")} · ${formatDate(due)} (${formatDistance(diffMs)})</div>
          ${it.notes ? `<div class="note">${escapeHtml(it.notes)}</div>` : ``}
          <div class="meta">
            <span class="badge amount">${sym}${(Number(it.amount||0)).toFixed(2)} ${it.currency || "GBP"}</span>
            ${isOverdue ? `<span class="badge overdue">Overdue</span>` : isSoon ? `<span class="badge soon">Soon</span>` : `<span class="badge ok">On track</span>`}
            ${it.recurrence?.type && it.recurrence.type !== "none" ? `<span class="badge">Repeats: ${escapeHtml(recurLabel(it))}</span>`: ``}
            ${tags.map(t => `<span class="badge">#${escapeHtml(t)}</span>`).join("")}
          </div>
        </div>
        <div class="actions">
          <button class="btn tiny" data-act="ics" title="Download .ics event">ICS</button>
          <button class="btn tiny" data-act="gcal" title="Open Google Calendar">GCal</button>
          <button class="btn tiny" data-act="snooze" title="Snooze 10 minutes">Snooze</button>
          <button class="btn tiny" data-act="edit">Edit</button>
          <button class="btn tiny warn" data-act="toggle">${it.completed ? "Unmark" : "Mark Paid"}</button>
          <button class="btn tiny danger" data-act="del">Delete</button>
        </div>
      `;
      // Actions
      div.querySelector('[data-act="edit"]').addEventListener("click", () => loadIntoForm(it.id));
      div.querySelector('[data-act="del"]').addEventListener("click", () => remove(it.id));
      div.querySelector('[data-act="toggle"]').addEventListener("click", () => toggleCompleted(it.id));
      div.querySelector('[data-act="snooze"]').addEventListener("click", () => snooze(it.id, 10*60*1000));
      div.querySelector('[data-act="ics"]').addEventListener("click", () => downloadICS(it));
      div.querySelector('[data-act="gcal"]').addEventListener("click", () => openGCal(it));

      listEl.appendChild(div);
    }

    // Totals
    const in30 = items.filter(it => {
      const d = new Date(it.dueISO);
      const ms = d - nowDt;
      return !it.completed && ms >= 0 && ms <= 30*86400000;
    });
    const sum30 = in30.reduce((a,it) => a + Number(it.amount||0), 0);
    const overdue = items.filter(it => !it.completed && new Date(it.dueISO) < nowDt);
    const active = items.filter(it => !it.completed);

    $("#sum30").textContent = `${currencySymbol("GBP")}${sum30.toFixed(2)}`;
    $("#overdueCount").textContent = overdue.length;
    $("#activeCount").textContent = active.length;

    $("#bar30").style.width = clamp(sum30 / 1000 * 100, 0, 100) + "%"; // scale reference
    $("#barOverdue").style.width = clamp((overdue.length / Math.max(active.length,1)) * 100, 0, 100) + "%";
    $("#barActive").style.width = clamp((active.length / Math.max(items.length,1)) * 100, 0, 100) + "%";
  }

  function recurLabel(it){
    const r = it.recurrence || {type:"none"};
    if (r.type === "custom") return `${r.intervalDays} days`;
    return r.type.charAt(0).toUpperCase() + r.type.slice(1);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function formatDistance(ms){
    const sign = ms < 0 ? "-" : "";
    ms = Math.abs(ms);
    const d = Math.floor(ms/86400000);
    ms -= d*86400000;
    const h = Math.floor(ms/3600000);
    ms -= h*3600000;
    const m = Math.floor(ms/60000);
    if (d > 0) return `${sign}${d}d ${h}h`;
    if (h > 0) return `${sign}${h}h ${m}m`;
    return `${sign}${m}m`;
  }

  // ---------- CRUD ----------
  function upsert(obj){
    const idx = items.findIndex(x => x.id === obj.id);
    if (idx >= 0) items[idx] = obj; else items.push(obj);
    save(); render();
  }
  function remove(id){
    if (!confirm("Delete this subscription?")) return;
    items = items.filter(x => x.id !== id);
    save(); render();
  }
  function byId(id){ return items.find(x => x.id === id); }
  function toggleCompleted(id){
    const it = byId(id); if (!it) return;
    it.completed = !it.completed;
    if (it.completed){
      // Immediately advance to next cycle if recurring
      advanceIfCompleted(it);
    }
    save(); render();
  }
  function snooze(id, ms){
    const it = byId(id); if (!it) return;
    const due = new Date(it.dueISO);
    due.setTime(due.getTime() + ms);
    it.dueISO = due.toISOString();
    it.lastNotified = {}; // reset reminders
    save(); render();
  }

  // ---------- Form ----------
  const form = $("#form");
  const remBoxes = $$(".rem");
  $("#recurrence").addEventListener("change", () => {
    $("#customInterval").classList.toggle("hidden", $("#recurrence").value !== "custom");
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = $("#id").value || crypto.randomUUID();
    const name = $("#name").value.trim();
    const dueDt = parseDateLocalToDate($("#due").value);
    if (!name || !dueDt){ alert("Name and due date/time are required."); return; }

    const amount = Number($("#amount").value || 0);
    const currency = $("#currency").value || "GBP";
    const notes = $("#notes").value || "";
    const tags = ($("#tags").value || "").split(",").map(s => s.trim()).filter(Boolean);
    const completed = ($("#completed").value === "true");

    const remindOffsets = remBoxes.filter(b => b.checked).map(b => Number(b.value));
    // Guarantee at least one default reminder if the user forgot
    const finalRem = remindOffsets.length ? remindOffsets : [86400000];

    const recurrenceType = $("#recurrence").value;
    const rec = { type: recurrenceType };
    if (recurrenceType === "custom"){
      const n = Number($("#customInterval").value || 0);
      if (!n || n <= 0){ alert("Custom recurrence requires a positive interval in days."); return; }
      rec.intervalDays = n;
    }

    // Ensure notification permission if user wants reminders
    if (finalRem.length && Notification?.permission !== "granted"){
      await ensureNotifPermission();
    }

    const obj = {
      id, name,
      dueISO: dueDt.toISOString(),
      amount, currency, notes, tags,
      recurrence: rec,
      remindOffsets: finalRem,
      createdAt: (byId(id)?.createdAt) || new Date().toISOString(),
      lastNotified: (byId(id)?.lastNotified) || {},
      completed
    };

    upsert(obj);
    form.reset();
    $("#id").value = "";
    $("#submitBtn").textContent = "Add Subscription";
  });

  $("#resetBtn").addEventListener("click", () => {
    form.reset();
    $("#id").value = "";
    $("#submitBtn").textContent = "Add Subscription";
  });

  function loadIntoForm(id){
    const it = byId(id); if (!it) return;
    $("#id").value = it.id;
    $("#name").value = it.name;
    $("#due").value = isoLocal(new Date(it.dueISO));
    $("#amount").value = Number(it.amount||0);
    $("#currency").value = it.currency || "GBP";
    $("#notes").value = it.notes || "";
    $("#tags").value = (it.tags||[]).join(", ");
    $("#completed").value = it.completed ? "true":"false";
    $("#recurrence").value = it.recurrence?.type || "none";
    if (it.recurrence?.type === "custom"){
      $("#customInterval").classList.remove("hidden");
      $("#customInterval").value = it.recurrence.intervalDays || 30;
    }else{
      $("#customInterval").classList.add("hidden");
      $("#customInterval").value = "";
    }
    remBoxes.forEach(b => b.checked = (it.remindOffsets||[]).includes(Number(b.value)));
    $("#submitBtn").textContent = "Update Subscription";
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  // ---------- Import / Export ----------
  $("#btnExport").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(items, null, 2)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "subscriptions.json"; a.click();
    URL.revokeObjectURL(url);
  });

  $("#btnImport").addEventListener("click", () => $("#fileImport").click());
  $("#fileImport").addEventListener("change", async (e) => {
    const f = e.target.files?.[0]; if (!f) return;
    const text = await f.text();
    try{
      const arr = JSON.parse(text);
      if (!Array.isArray(arr)) throw new Error("Invalid file");
      // naive merge by id, otherwise add
      for (const obj of arr){
        if (!obj.id) obj.id = crypto.randomUUID();
        if (!obj.lastNotified) obj.lastNotified = {};
        upsert(obj);
      }
      alert("Imported.");
    }catch(err){
      alert("Failed to import: " + err.message);
    }
  });

  // ---------- Search/Filter ----------
  $("#search").addEventListener("input", render);
  $("#filter").addEventListener("change", render);

  // ---------- Calendar Integration ----------
  function downloadICS(it){
    const dtStart = new Date(it.dueISO);
    const dtEnd = new Date(dtStart.getTime() + 60*60*1000);
    const toICS = (d) => {
      // UTC Z format YYYYMMDDTHHMMSSZ
      const pad = n => String(n).padStart(2,"0");
      return d.getUTCFullYear()
        + pad(d.getUTCMonth()+1)
        + pad(d.getUTCDate())
        + "T"
        + pad(d.getUTCHours())
        + pad(d.getUTCMinutes())
        + pad(d.getUTCSeconds()) + "Z";
    };
    const uid = it.id + "@local.submgr";
    const desc = `Amount: ${currencySymbol(it.currency||"GBP")}${Number(it.amount||0).toFixed(2)} ${it.currency || "GBP"}\\n` +
      `Notes: ${(it.notes||"").replace(/\n/g,"\\n")}`;
    const ics = [
      "BEGIN:VCALENDAR",
      "VERSION:2.0",
      "PRODID:-//Local//SubscriptionReminder//EN",
      "BEGIN:VEVENT",
      `UID:${uid}`,
      `DTSTAMP:${toICS(new Date())}`,
      `DTSTART:${toICS(dtStart)}`,
      `DTEND:${toICS(dtEnd)}`,
      `SUMMARY:${escapeICS(it.name)}`,
      `DESCRIPTION:${escapeICS(desc)}`,
      "END:VEVENT",
      "END:VCALENDAR"
    ].join("\r\n");
    const blob = new Blob([ics], {type: "text/calendar"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = sanitizeFilename(it.name) + ".ics"; a.click();
    URL.revokeObjectURL(url);
  }
  function escapeICS(s){ return String(s).replace(/([,;])/g,"\\$1"); }
  function sanitizeFilename(s){ return s.replace(/[^\w\-]+/g,"_").slice(0,64); }

  function openGCal(it){
    const start = new Date(it.dueISO);
    const end = new Date(start.getTime() + 60*60*1000);
    const fmt = (d) => {
      const pad = n => String(n).padStart(2,"0");
      return d.getUTCFullYear()
        + pad(d.getUTCMonth()+1)
        + pad(d.getUTCDate()) + "T"
        + pad(d.getUTCHours()) + pad(d.getUTCMinutes()) + pad(d.getUTCSeconds()) + "Z";
    };
    const params = new URLSearchParams({
      action: "TEMPLATE",
      text: it.name,
      dates: `${fmt(start)}/${fmt(end)}`,
      details: `Subscription due. Amount ${currencySymbol(it.currency||"GBP")}${Number(it.amount||0).toFixed(2)} ${it.currency||"GBP"}.\n${it.notes||""}`,
    });
    const url = "https://calendar.google.com/calendar/render?" + params.toString();
    window.open(url, "_blank", "noopener");
  }

  // ---------- Scheduler ----------
  // Instead of one huge setTimeout (which breaks >24.8 days), we poll every minute
  // and on visibility/wake to fire reminders exactly when they cross thresholds.
  function schedulerTick(){
    const tNow = now().getTime();
    const N = items.length;
    for (let i=0;i<N;i++){
      const it = items[i];
      if (it.completed) continue;
      const due = new Date(it.dueISO).getTime();
      const delta = due - tNow;
      const offsets = (it.remindOffsets || []);
      for (const off of offsets){
        // Reminder should fire when delta <= off and not previously fired for this offset
        // Also don't fire long before creation time by mistake; only if we're within off+2 minutes window
        if (delta <= off && !it.lastNotified[off]){
          // Ensure within tolerance (so we don't double-fire across ticks)
          const tol = 120000; // 2 minutes tolerance around the boundary
          if (delta > (off - tol)){
            it.lastNotified[off] = true;
            save();
            const whenTxt = off >= 86400000 ? `${Math.round(off/86400000)} day(s)` :
                             off >= 3600000 ? `${Math.round(off/3600000)} hour(s)` :
                             `${Math.round(off/60000)} minute(s)`;
            notify(`Reminder: ${it.name}`, `Due in ${whenTxt} — ${formatDate(new Date(due))}`, it.id + ":" + off);
            beep();
          }
        }
      }
      // If overdue by crossing zero and we haven't notified a "due now" tag:
      if (delta <= 0 && !it.lastNotified["due"]){
        it.lastNotified["due"] = true; save();
        notify(`⚠️ Due: ${it.name}`, `Due now — ${formatDate(new Date(due))}`, it.id + ":due");
        beep();
      }
    }
  }

  // Run ticks
  setInterval(schedulerTick, 60000);
  document.addEventListener("visibilitychange", () => { if (document.visibilityState === "visible") schedulerTick(); });
  window.addEventListener("focus", schedulerTick);
  window.addEventListener("load", () => { schedulerTick(); render(); });

  // ---------- Demo data ----------
  $("#btnSample").addEventListener("click", () => {
    const base = now();
    const mk = (name, dOffDays, amt, cur, offs=[86400000, 3600000], recurrence="monthly", tags=[], notes="") => ({
      id: crypto.randomUUID(),
      name,
      dueISO: new Date(base.getTime() + dOffDays*86400000).toISOString(),
      amount: amt, currency: cur, notes, tags,
      recurrence: recurrence==="custom" ? {type:"custom", intervalDays:30} : {type:recurrence},
      remindOffsets: offs,
      createdAt: new Date().toISOString(),
      lastNotified: {},
      completed: false
    });
    const demo = [
      mk("Netflix", 6, 10.99, "GBP", [604800000, 86400000, 3600000], "monthly", ["streaming"], "Standard plan"),
      mk("Phone Bill", 2, 22.00, "GBP", [86400000, 3600000], "monthly", ["utility"], "Unlimited data"),
      mk("Rent", 10, 650.00, "GBP", [604800000, 86400000, 21600000], "monthly", ["housing"], "Shared flat"),
      mk("Gym", 1, 19.99, "GBP", [86400000], "monthly", ["fitness"], "24/7 access"),
      mk("Domain Renewal", 27, 12.00, "GBP", [604800000, 86400000], "yearly", ["web"], "kai9987kai.pw")
    ];
    items = items.concat(demo);
    save(); render(); schedulerTick();
  });

  // ---------- Keyboard niceties ----------
  $("#search").addEventListener("keydown", (e) => {
    if (e.key === "Escape"){ e.target.value=""; render(); }
  });

  // ---------- Init defaults ----------
  // Default due time to 09:00 local today
  (function setDefaultDue(){
    const t = new Date();
    t.setHours(9,0,0,0);
    $("#due").value = isoLocal(t);
  })();

  // Initial render
  render();

  // ---------- Helper: Export ICS from card button already implemented above ----------

  // ---------- Helper: name sanitization used by ICS ----------
  // (already defined sanitizeFilename)

  // ---------- Open item in form if hash like #edit=<id> ----------
  (function checkHash(){
    const m = location.hash.match(/edit=([^&]+)/);
    if (m){
      const it = byId(m[1]); if (it) loadIntoForm(it.id);
    }
  })();

  // ---------- Escape hatch for global debug in console ----------
  window.__submgr = { items, render, save };

  </script>
</body>
</html>
